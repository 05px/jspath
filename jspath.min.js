/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.0.9
*/(function(a){var b;typeof exports=="object"?a(b,exports):typeof define=="function"?define(a):a(b,JSPath={})})(function(a,b){function i(a){e=a,f=0,g=null,h=e.length;var b=j(),d=E();return d.type!==c.EOP&&N(d),b}function j(){var a=!1;z("^")&&(E(),a=!0),A()||N(E());var b=[],c;while(f<h){c=k();if(!c)break;b.push(c)}return a?function(a,c,d){return P(c,c,d,b)}:function(a,c,d){return P(a,c,d,b)}}function k(){if(A())return l();if(z("["))return n();if(z("{"))return o()}function l(){var a=E().val,b=C(),d;if(z("*")||a===".."||b.type===c.ID||b.type===c.STRING)d=m();return a===".."?U(d):d?R(d):Q}function m(){var a=E(),b=a.type;if(b===c.ID||b===c.STRING||b===c.PUNCTUATOR&&a.val==="*")return a.val;N(a)}function n(){B("[");var a=v();return B("]"),a}function o(){B("{");var a=p();return B("}"),function(b,c,d){var e=[],f=0,g=b.length,h,i;while(f<g)i=a(h=b[f++],c,d),(typeof i=="boolean"?i:V(i))&&e.push(h);return e}}function p(){var a=q(),b;while(z("||"))E(),(b||(b=[a])).push(q());return b?function(a,c,d){var e=0,f;while(f=b[e++])if(V(f(a,c,d)))return!0;return!1}:a}function q(){var a=r(),b;while(z("&&"))E(),(b||(b=[a])).push(r());return b?function(a,c,d){var e=0,f;while(f=b[e++])if(!V(f(a,c,d)))return!1;return!0}:a}function r(){var a=s(),b;while(z("==")||z("!=")||z("===")||z("!==")||z("^=")||z("^==")||z("$==")||z("$=")||z("*==")||z("*="))(b||(b=[a])).push(W[E().val],s());return b?X(b,Y):a}function s(){var a=t(),b;while(z("<")||z(">")||z("<=")||z(">="))(b||(b=[a])).push(W[E().val],t());return b?X(b,Y):a}function t(){var a=u(),b;while(z("+")||z("-"))(b||(b=[a])).push(W[E().val],u());return b?X(b,Z):a}function u(){var a=w(),b;while(z("*")||z("/")||z("%"))(b||(b=[a])).push(W[E().val],w());return b?X(b,Z):a}function v(){if(z(":")){E();var a=w();return function(b,c,d){return b.slice(0,a(b,c,d))}}var b=w();if(z(":")){E();if(z("]"))return function(a,c,d){return a.slice(b(a,c,d))};var a=w();return function(c,d,e){return c.slice(b(c,d,e),a(c,d,e))}}return function(a,c,d){var e=b(a,c,d),f=e>=0?a[e]:a[a.length+e];return typeof f=="undefined"?f:[f]}}function w(){if(z("!")){E();var a=w();return function(b,c,d){return!V(a(b,c,d))}}if(z("-")){E();var a=w();return function(b,c,d){return-a(b,c,d)}}return x()}function x(){var a=C(),b=a.type;if(b===c.STRING||b===c.NUMERIC||b===c.BOOLEAN){var d=E().val;return function(){return d}}if(b===c.ID&&a.val[0]==="$"){var e=E().val.substr(1);return function(a,b,c){return c[e]}}return z("^")||A()?j():z("(")?y():N(E())}function y(){B("(");var a=p();return B(")"),a}function z(a){var b=C();return b.type===c.PUNCTUATOR&&b.val===a}function A(){var a=C();if(a.type===c.PUNCTUATOR){var b=a.val;return b==="."||b===".."}return!1}function B(a){var b=E();(b.type!==c.PUNCTUATOR||b.val!==a)&&N(b)}function C(){var a;return g!==null?g:(a=f,g=D(),f=a,g)}function D(){while(G(e[f]))++f;if(f>=h)return{type:c.EOP,range:[f,f]};var a=M();if(a)return a;a=K();if(a)return a;a=L();if(a)return a;a=J();if(a)return a;N({val:e[f],range:[f,f]})}function E(){var a;return g?(f=g.range[1],a=g,g=null,a):D()}function F(a){return"0123456789".indexOf(a)>=0}function G(a){return a===" "}function H(a){return a==="$"||a==="_"||a>="a"&&a<="z"||a>="A"&&a<="Z"}function I(a){return H(a)||a>="0"&&a<="9"}function J(){var a=e[f];if(!H(a))return;var b=f,d=e[f];while(++f<h){a=e[f];if(!I(a))break;d+=a}return d==="true"||d==="false"?{type:c.BOOLEAN,val:d==="true",range:[b,f]}:{type:c.ID,val:d,range:[b,f]}}function K(){if(e[f]!=='"')return;var a=++f,b="",d;while(f<h){d=e[f++];if(d==='"')break;b+=d}return{type:c.STRING,val:b,range:[a,f]}}function L(){var a=f,b=e[f],d=b===".";if(d||F(b)){var g=b;while(++f<h){b=e[f];if(b==="."){if(d)return;d=!0}else if(!F(b))break;g+=b}return{type:c.NUMERIC,val:d?parseFloat(g):parseInt(g,10),range:[a,f]}}}function M(){var a=f,b=e[f],d=e[f+1];if(b==="."){if(F(d))return;return e[++f]==="."?{type:c.PUNCTUATOR,val:"..",range:[a,++f]}:{type:c.PUNCTUATOR,val:".",range:[a,f]}}if(d==="="){var g=e[f+2];if(g==="="){if("=!^$*".indexOf(b)>=0)return{type:c.PUNCTUATOR,val:b+d+g,range:[a,f+=3]}}else if("=!^$*><".indexOf(b)>=0)return{type:c.PUNCTUATOR,val:b+d,range:[a,f+=2]}}if(b===d&&(b==="|"||b==="&"))return{type:c.PUNCTUATOR,val:b+d,range:[a,f+=2]};if(":{}()[]^+-*/%!><".indexOf(b)>=0)return{type:c.PUNCTUATOR,val:b,range:[a,++f]}}function N(a){a.type===c.EOP&&O(a,d.UNEXPECTED_EOP),O(a,d.UNEXPECTED_TOKEN,a.val)}function O(a,b){var c=Array.prototype.slice.call(arguments,2),d=b.replace(/%(\d)/g,function(a,b){return c[b]||""}),e=new Error(d);throw e.column=a.range[0],e}function P(a,b,c,d){var e,f=0,g=Array.isArray(a)?a:[a];while(e=d[f++]){g=e(g,b,c);if(!g||!g.length)return[]}return g}function Q(a){return a}function R(a){var b="var res = [], i = 0, len = ctx.length,curCtx, j, val;while(i < len) {curCtx = ctx[i++];"+S(a,"res")+"}"+"return res;";return Function("ctx",b)}function S(a,b){return"if(curCtx != null) {"+(a==="*"?"for(j in curCtx) {if(curCtx.hasOwnProperty(j)) {val = curCtx[j];"+T(b,"val")+"}"+"}":'val = curCtx["'+a+'"];'+'if(typeof val !== "undefined") {'+T(b,"val")+"}")+"}"}function T(a,b){return"Array.isArray("+b+")? "+a+" = "+a+".concat("+b+") : "+a+".push("+b+");"}function U(a){var b='ctx = ctx.slice();var res = [], curCtx, childCtxs,i, j, val, vals;while(ctx.length) {if(typeof (curCtx = ctx.shift()) === "object" && curCtx !== null) {childCtxs = [];if(Array.isArray(curCtx)) {i = 0; len = curCtx.length;while(i < len) {val = curCtx[i++];'+T("childCtxs","val")+"}"+"}"+"else {"+"vals = [];"+S(a,"vals")+T("res","vals")+"for(var j in curCtx) {"+"if(curCtx.hasOwnProperty(j)) {"+"val = curCtx[j];"+T("childCtxs","val")+"}"+"}"+"}"+"childCtxs.length && ctx.unshift.apply(ctx, childCtxs);"+"}"+"}"+"return res;";return Function("ctx",b)}function V(a){return Array.isArray(a)?!!a.length:!!a}function X(a,b){return function(c,d,e){var f=a,g=1,h=f.length-1,i=f[0](c,d,e);while(g<h)i=b(i,f[g+1](c,d,e),f[g]),g+=2;return i}}function Y(a,b,c){var d=Array.isArray(a),e=Array.isArray(b);d&&a.length===1&&(a=a[0],d=!1),e&&b.length===1&&(b=b[0],e=!1);var f=0,g;if(d){var h=a.length,i;if(e){g=b.length;while(f<h){i=0;while(i<g)if(c(a[f],b[i++]))return!0;++f}return!1}while(f<h)if(c(a[f++],b))return!0;return!1}if(e){g=b.length;while(f<g)if(c(a,b[f++]))return!0;return!1}return c(a,b)}function Z(a,b,c){return c(Array.isArray(a)?a[0]:a,Array.isArray(b)?b[0]:b)}var c={ID:1,NUMERIC:2,STRING:3,BOOLEAN:4,PUNCTUATOR:5,EOP:6},d={UNEXPECTED_TOKEN:'Unexpected token "%0"',UNEXPECTED_EOP:"Unexpected end of path"},e,f,g,h,W={"===":function(a,b){return a===b},"==":function(a,b){return typeof a=="string"&&typeof b=="string"?a.toLowerCase()===b.toLowerCase():a==b},">=":function(a,b){return a>=b},">":function(a,b){return a>b},"<=":function(a,b){return a<=b},"<":function(a,b){return a<b},"!==":function(a,b){return a!==b},"!=":function(a,b){return a!=b},"^==":function(a,b){return typeof a=="string"&&typeof b=="string"&&a.indexOf(b)===0},"^=":function(a,b){return a!==null&&b!==null&&a.toString().toLowerCase().indexOf(b.toString().toLowerCase())===0},"$==":function(a,b){return typeof a=="string"&&typeof b=="string"&&a.indexOf(b,a.length-b.length)>-1},"$=":function(a,b){if(a===null||b===null)return!1;var c=a.toString().toLowerCase(),d=b.toString().toLowerCase();return c.indexOf(d,c.length-d.length)>-1},"*==":function(a,b){return typeof a=="string"&&typeof b=="string"&&a.indexOf(b)>-1},"*=":function(a,b){return a!==null&&b!==null&&a.toString().toLowerCase().indexOf(b.toString().toLowerCase())>-1},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b}};b._parse=i;var $=100,_={},ab=[];b.apply=function(a,b,c){return _[a]||(_[a]=i(a),ab.push(a)>$&&delete _[ab.shift()]),_[a](b,b,c||{})}});