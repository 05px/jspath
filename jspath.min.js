/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.0.1
*/(function(a){var b;typeof exports=="object"?a(b,exports):typeof define=="function"?define(a):a(b,JSPath={})})(function(a,b){function i(a){e=a,f=0,g=null,h=e.length;var b=j(),d=D();return d.type!==c.EOP&&N(d),b}function j(){var a=!1;y("^")&&(D(),a=!0),z()||N(D());var b=[],c;while(f<h){c=k();if(!c)break;b.push(c)}return a?function(a,c,d){return P(c,c,d,b)}:function(a,c,d){return P(a,c,d,b)}}function k(){if(z()){var a=D().val,b=B(),d;if(y("*")||a===".."||b.type===c.ID||b.type===c.STRING)d=l();return a===".."?function(a){return S(a,d)}:d?function(a){return R(a,d)}:Q}if(y("["))return m();if(y("{"))return n()}function l(){var a=D(),b=a.type;if(b===c.ID||b===c.STRING||b===c.PUNCTUATOR&&a.val==="*")return a.val;N(a)}function m(){A("[");var a=u();return A("]"),a}function n(){A("{");var a=o();return A("}"),function(b,c,d){var e=[],f=0,g=b.length,h;while(f<g)U(a(h=b[f++],c,d))&&e.push(h);return e}}function o(){var a=p(),b;while(y("||"))D(),(b||(b=[a])).push(p());return b?function(a,c,d){var e=0,f;while(f=b[e++])if(U(f(a,c,d)))return!0;return!1}:a}function p(){var a=q(),b;while(y("&&"))D(),(b||(b=[a])).push(q());return b?function(a,c,d){var e=0,f;while(f=b[e++])if(!U(f(a,c,d)))return!1;return!0}:a}function q(){var a=r(),b;while(y("==")||y("!=")||y("===")||y("!==")||y("^=")||y("^==")||y("$==")||y("$=")||y("*==")||y("*="))(b||(b=[a])).push(D().val,r());return b?V(b,X):a}function r(){var a=s(),b;while(y("<")||y(">")||y("<=")||y(">="))(b||(b=[a])).push(D().val,s());return b?V(b,X):a}function s(){var a=t(),b;while(y("+")||y("-"))(b||(b=[a])).push(D().val,t());return b?V(b,Y):a}function t(){var a=v(),b;while(y("*")||y("/")||y("%"))(b||(b=[a])).push(D().val,v());return b?V(b,Y):a}function u(){if(y(":")){D();var a=v();return function(b,c,d){return b.slice(0,a(b,c,d))}}var b=v();if(y(":")){D();if(y("]"))return function(a,c,d){return a.slice(b(a,c,d))};var a=v();return function(c,d,e){return c.slice(b(c,d,e),a(c,d,e))}}return function(a,c,d){var e=b(a,c,d),f=e>=0?a[e]:a[a.length+e];return f&&[f]}}function v(){if(y("!")){D();var a=v();return function(b,c,d){return!U(a(b,c,d))}}if(y("-")){D();var a=v();return function(b,c,d){return-a(b,c,d)}}return w()}function w(){var a=B(),b=a.type;if(b===c.STRING||b===c.NUMERIC||b===c.BOOLEAN){var d=D().val;return function(){return d}}if(b===c.ID&&a.val[0]==="$"){var e=D().val.substr(1);return function(a,b,c){return c[e]}}return y("^")||z()?j():y("(")?x():N(D())}function x(){A("(");var a=o();return A(")"),a}function y(a){var b=B();return b.type===c.PUNCTUATOR&&b.val===a}function z(){var a=B();if(a.type===c.PUNCTUATOR){var b=a.val;return b==="."||b===".."}return!1}function A(a){var b=D();(b.type!==c.PUNCTUATOR||b.val!==a)&&N(b)}function B(){var a;return g!==null?g:(a=f,g=C(),f=a,g)}function C(){while(G(e[f]))++f;if(f>=h)return{type:c.EOP,range:[f,f]};var a=M();if(a)return a;a=K();if(a)return a;a=L();if(a)return a;a=J();if(a)return a;N({val:e[f],range:[f,f]})}function D(){var a;return g?(f=g.range[1],a=g,g=null,a):(g=null,C())}function E(){return e[f++]}function F(a){return"0123456789".indexOf(a)>=0}function G(a){return a===" "}function H(a){return a==="$"||a==="_"||a>="a"&&a<="z"||a>="A"&&a<="Z"}function I(a){return a==="$"||a==="_"||a>="a"&&a<="z"||a>="A"&&a<="Z"||a>="0"&&a<="9"}function J(){var a=e[f];if(!H(a))return;var b=f,d=E();while(f<h){a=e[f];if(!I(a))break;d+=E()}return d==="true"||d==="false"?{type:c.BOOLEAN,val:d==="true",range:[b,f]}:{type:c.ID,val:d,range:[b,f]}}function K(){if(e[f]!=='"')return;var a=++f,b="",d;while(f<h){d=E();if(d==='"')break;b+=d}return{type:c.STRING,val:b,range:[a,f]}}function L(){var a=f,b=e[f],d=b===".";if(d||F(b)){var g=b;++f;while(f<h){b=e[f];if(b==="."){if(d)return;d=!0}else if(!F(b))break;g+=b,++f}return{type:c.NUMERIC,val:d?parseFloat(g):parseInt(g,10),range:[a,f]}}}function M(){var a=f,b=e[f],d=e[f+1];if(b==="."){if(F(d))return;return e[++f]==="."?{type:c.PUNCTUATOR,val:"..",range:[a,++f]}:{type:c.PUNCTUATOR,val:".",range:[a,f]}}if(d==="="){var g=e[f+2];if(g==="="){if("=!^$*".indexOf(b)>=0)return{type:c.PUNCTUATOR,val:b+d+g,range:[a,f+=3]}}else if("=!^$*><".indexOf(b)>=0)return{type:c.PUNCTUATOR,val:b+d,range:[a,f+=2]}}if(b===d&&(b==="|"||b==="&"))return{type:c.PUNCTUATOR,val:b+d,range:[a,f+=2]};if(":{}()[]^+-*/%!><".indexOf(b)>=0)return{type:c.PUNCTUATOR,val:b,range:[a,++f]}}function N(a){a.type===c.EOP&&O(a,d.UNEXPECTED_EOP),O(a,d.UNEXPECTED_TOKEN,a.val)}function O(a,b){var c=Array.prototype.slice.call(arguments,2),d=b.replace(/%(\d)/g,function(a,b){return c[b]||""}),e=new Error(d);throw e.column=a.range[0],e}function P(a,b,c,d){var e,f=0,g=Array.isArray(a)?a:[a];while(e=d[f++]){g=e(g,b,c);if(!g||!g.length)return[]}return g}function Q(a){return a}function R(a,b){var c,d=0,e=a.length,f;while(d<e)f=a[d++],typeof f=="object"&&f!==null&&(c=T(c,b==="*"?Object.keys(f).map(function(a){return f[a]}):f[b]));return c}function S(a,b,c){var d=[],e,f,a=a.slice();while(a.length){e=a.shift();if(typeof e!="object"||e===null)continue;b==="*"?d=d.concat(R([e],b)):e.hasOwnProperty(b)&&d.push(e[b]),f=c,Array.isArray(e)?e.forEach(function(a){typeof a=="object"&&(f=T(f,a))}):Object.keys(e).forEach(function(a){typeof e[a]=="object"&&(f=T(f,e[a]))}),f&&(a=f.concat(a))}return d}function T(a,b){return typeof b=="undefined"?a:a?Array.isArray(b)?a.concat(b):(a.push(b),a):Array.isArray(b)?b:[b]}function U(a){return Array.isArray(a)?!!a.length:!!a}function V(a,b){return function(c,d,e){var f=1,g=a.length-1,h=a[0](c,d,e);while(f<g)h=b(h,a[f+1](c,d,e),a[f]),f+=2;return h}}function X(a,b,c){var d=W[c],e=Array.isArray(a),f=Array.isArray(b);return e&&a.length===1&&(a=a[0],e=!1),f&&b.length===1&&(b=b[0],f=!1),e?f?a.some(function(a){return b.some(function(b){return d(a,b)})}):a.some(function(a){return d(a,b)}):f?b.some(function(b){return d(a,b)}):d(a,b)}function Y(a,b,c){return W[c](Array.isArray(a)?a[0]:a,Array.isArray(b)?b[0]:b)}var c={ID:1,NUMERIC:2,STRING:3,BOOLEAN:4,PUNCTUATOR:5,EOP:6},d={UNEXPECTED_TOKEN:'Unexpected token "%0"',UNEXPECTED_EOP:"Unexpected end of path"},e,f,g,h,W={"===":function(a,b){return a===b},"==":function(a,b){return typeof a=="string"&&typeof b=="string"?a.toLowerCase()===b.toLowerCase():a==b},">=":function(a,b){return a>=b},">":function(a,b){return a>b},"<=":function(a,b){return a<=b},"<":function(a,b){return a<b},"!==":function(a,b){return a!==b},"!=":function(a,b){return a!=b},"^==":function(a,b){return typeof a=="string"&&typeof b=="string"&&a.indexOf(b)===0},"^=":function(a,b){return a!==null&&b!==null&&a.toString().toLowerCase().indexOf(b.toString().toLowerCase())===0},"$==":function(a,b){return typeof a=="string"&&typeof b=="string"&&a.indexOf(b,a.length-b.length)>-1},"$=":function(a,b){if(a===null||b===null)return!1;var c=a.toString().toLowerCase(),d=b.toString().toLowerCase();return c.indexOf(d,c.length-d.length)>-1},"*==":function(a,b){return typeof a=="string"&&typeof b=="string"&&a.indexOf(b)>-1},"*=":function(a,b){return a!==null&&b!==null&&a.toString().toLowerCase().indexOf(b.toString().toLowerCase())>-1},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"/":function(a,b){return a/b},"%":function(a,b){return a%b}};b._parse=i;var Z={};b.apply=function(a,b,c){return(Z[a]||(Z[a]=i(a)))(b,b,c||{})}});