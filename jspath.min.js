/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* With parts by Marat Dulin (mdevils@gmail.com)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.1
*/(function(a){var b;typeof exports=="object"?a(b,exports):typeof define=="function"?define(a):a(b,JSPath={})})(function(a,b){function f(a){return Function("data,subst",e(d(a)))}var c={PATH:1,SELECTOR:2,OBJECT_PREDICATE:3,ARRAY_PREDICATE:4,LOGICAL_EXPRESSION:5,BINARY_EXPRESSION:6,UNARY_EXPRESSION:7,ARRAY_EXPRESSION:8,LITERAL:9,SUBST:10},d=function(){function h(b){d=b,e=0,f=null,g=d.length;var c=i(),h=D();return h.type!==a.EOP&&M(h),c}function i(){var a=!1;y("^")&&(D(),a=!0),z()||M(D());var b=[],d;while(e<g){d=j();if(!d)break;b.push(d)}return{type:c.PATH,fromRoot:a,parts:b}}function j(){if(z())return k();if(y("["))return m();if(y("{"))return n()}function k(){var b=D().val,d=B(),e;if(y("*")||b===".."||d.type===a.ID||d.type===a.STRING)e=l();return{type:c.SELECTOR,selector:b,prop:e}}function l(){var b=D(),c=b.type;if(c===a.ID||c===a.STRING||c===a.PUNCTUATOR&&b.val==="*")return b.val;M(b)}function m(){A("[");var a=u();return A("]"),{type:c.ARRAY_PREDICATE,arg:a}}function n(){A("{");var a=o();return A("}"),{type:c.OBJECT_PREDICATE,arg:a}}function o(){var a=p(),b;while(y("||"))D(),(b||(b=[a])).push(p());return b?{type:c.LOGICAL_EXPRESSION,op:"||",args:b}:a}function p(){var a=q(),b;while(y("&&"))D(),(b||(b=[a])).push(q());return b?{type:c.LOGICAL_EXPRESSION,op:"&&",args:b}:a}function q(){var a=r();while(y("==")||y("!=")||y("===")||y("!==")||y("^=")||y("^==")||y("$==")||y("$=")||y("*==")||y("*="))a={type:c.BINARY_EXPRESSION,op:D().val,args:[a,q()]};return a}function r(){var a=s();while(y("<")||y(">")||y("<=")||y(">="))a={type:c.BINARY_EXPRESSION,op:D().val,args:[a,r()]};return a}function s(){var a=t();while(y("+")||y("-"))a={type:c.BINARY_EXPRESSION,op:D().val,args:[a,s()]};return a}function t(){var a=v();while(y("*")||y("/")||y("%"))a={type:c.BINARY_EXPRESSION,op:D().val,args:[a,t()]};return a}function u(){if(y(":"))return D(),{type:c.ARRAY_EXPRESSION,toIdx:v()};var a=v();return y(":")?(D(),y("]")?{type:c.ARRAY_EXPRESSION,fromIdx:a}:{type:c.ARRAY_EXPRESSION,fromIdx:a,toIdx:v()}):{type:c.ARRAY_EXPRESSION,idx:a}}function v(){return y("!")||y("-")?{type:c.UNARY_EXPRESSION,op:D().val,arg:v()}:w()}function w(){var b=B(),d=b.type;return d===a.STRING||d===a.NUMERIC||d===a.BOOLEAN?{type:c.LITERAL,val:D().val}:d===a.ID&&b.val[0]==="$"?{type:c.SUBST,name:D().val.substr(1)}:y("^")||z()?i():y("(")?x():M(D())}function x(){A("(");var a=o();return A(")"),a}function y(b){var c=B();return c.type===a.PUNCTUATOR&&c.val===b}function z(){var b=B();if(b.type===a.PUNCTUATOR){var c=b.val;return c==="."||c===".."}return!1}function A(b){var c=D();(c.type!==a.PUNCTUATOR||c.val!==b)&&M(c)}function B(){var a;return f!==null?f:(a=e,f=C(),e=a,f)}function C(){while(F(d[e]))++e;if(e>=g)return{type:a.EOP,range:[e,e]};var b=L();if(b)return b;b=J();if(b)return b;b=K();if(b)return b;b=I();if(b)return b;M({val:d[e],range:[e,e]})}function D(){var a;return f?(e=f.range[1],a=f,f=null,a):C()}function E(a){return"0123456789".indexOf(a)>=0}function F(a){return a===" "}function G(a){return a==="$"||a==="_"||a>="a"&&a<="z"||a>="A"&&a<="Z"}function H(a){return G(a)||a>="0"&&a<="9"}function I(){var b=d[e];if(!G(b))return;var c=e,f=d[e];while(++e<g){b=d[e];if(!H(b))break;f+=b}return f==="true"||f==="false"?{type:a.BOOLEAN,val:f==="true",range:[c,e]}:{type:a.ID,val:f,range:[c,e]}}function J(){if(d[e]!=='"')return;var b=++e,c="",f;while(e<g){f=d[e++];if(f==='"')break;c+=f}return{type:a.STRING,val:c,range:[b,e]}}function K(){var b=e,c=d[e],f=c===".";if(f||E(c)){var h=c;while(++e<g){c=d[e];if(c==="."){if(f)return;f=!0}else if(!E(c))break;h+=c}return{type:a.NUMERIC,val:f?parseFloat(h):parseInt(h,10),range:[b,e]}}}function L(){var b=e,c=d[e],f=d[e+1];if(c==="."){if(E(f))return;return d[++e]==="."?{type:a.PUNCTUATOR,val:"..",range:[b,++e]}:{type:a.PUNCTUATOR,val:".",range:[b,e]}}if(f==="="){var g=d[e+2];if(g==="="){if("=!^$*".indexOf(c)>=0)return{type:a.PUNCTUATOR,val:c+f+g,range:[b,e+=3]}}else if("=!^$*><".indexOf(c)>=0)return{type:a.PUNCTUATOR,val:c+f,range:[b,e+=2]}}if(c===f&&(c==="|"||c==="&"))return{type:a.PUNCTUATOR,val:c+f,range:[b,e+=2]};if(":{}()[]^+-*/%!><".indexOf(c)>=0)return{type:a.PUNCTUATOR,val:c,range:[b,++e]}}function M(c){c.type===a.EOP&&N(c,b.UNEXPECTED_EOP),N(c,b.UNEXPECTED_TOKEN,c.val)}function N(a,b){var c=Array.prototype.slice.call(arguments,2),d=b.replace(/%(\d)/g,function(a,b){return c[b]||""}),e=new Error(d);throw e.column=a.range[0],e}var a={ID:1,NUMERIC:2,STRING:3,BOOLEAN:4,PUNCTUATOR:5,EOP:6},b={UNEXPECTED_TOKEN:'Unexpected token "%0"',UNEXPECTED_EOP:"Unexpected end of path"},d,e,f,g;return h}(),e=function(){function g(){if(f.length)return f.shift();var a="v"+ ++d;return b.push(a),a}function h(){return"lbl"+ ++e}function i(){for(var a=0,b=arguments.length;a<b;a++)f.push(arguments[a])}function j(c){return a=[],b=["res"],d=0,e=0,f=[],k(c,"res","data",!0),"data = Array.isArray(data)? data : [data];"+(b.length?"var "+b.join(",")+";":"")+a.join("")+"return res;"}function k(b,d,e,f){var h=g(),j=b.parts,k=0,m=j.length;a.push(h,"=",b.fromRoot?"data":e,";");while(k<m){var o=j[k++];switch(o.type){case c.SELECTOR:o.selector==".."?p(o,h,h):n(o,h,h);break;case c.OBJECT_PREDICATE:a.push(q(o,h,h));break;case c.ARRAY_PREDICATE:a.push(l(o,h,h))}f&&a.push("if(!",h,".length) {","return ",h,";","}")}a.push(d,"=",h,";"),i(h)}function l(b,c,d){var e=b.arg,f,h;if(e.idx){var j=g();r(e.idx,j,d),a.push(j,"=",m(j,d),";",c,"=",d,"[",j,"] == null? [] : [",d,"[",j,"]];"),i(j)}else e.fromIdx?e.toIdx?(f=g(),h=g(),r(e.fromIdx,f,d),r(e.toIdx,h,d),a.push(f,"=",m(f,d),";",h,"=",m(h,d),";",c,"=",d,".slice(",f,", ",h,");"),i(f,h)):(f=g(),r(e.fromIdx,f,d),a.push(f,"=",m(f,d),";",c,"=",d,".slice(",f,");"),i(f)):(h=g(),r(e.toIdx,h,d),a.push(h,"=",m(h,d),";",c,"=",d,".slice(0, ",h,");"),i(h))}function m(a,b){return[a,"< 0?",b,".length +",a,":",a].join("")}function n(b,c,d){if(!b.prop)a.push(c,"=",d,";");else{var e=x(b.prop),f=g(),h=g(),j=g(),k=g(),l=g(),m=g();a.push(f,"= [],",h,"= 0,",j,"=",d,".length;","while(",h,"<",j,") {",k,"=",d,"[",h,"++];","if(",k,"!= null) {"),b.prop==="*"?a.push("for(",l," in ",k,") {","if(",k,".hasOwnProperty(",l,")) {",m,"=",k,"[",l,"];",y(f,m),"}","}"):a.push(m,"=",k,"[",e,"];",y(f,m)),a.push("}","}",c,"=",f,";"),i(f,h,j,k,l,m)}}function o(b,c,d,e,f){a.push("if(",d,"!= null) {"),b==="*"?a.push("for(",e," in ",d,") {","if(",d,".hasOwnProperty(",e,")) {",f,"=",d,"[",e,"];",y(c,f),"}","}"):a.push(f,"=",d,'["'+b+'"];',y(c,f)),a.push("}")}function p(b,c,d){var e=g(),f=g(),h=g(),j=g(),k=g(),l=g(),m=g(),n=g(),p=g();a.push(e,"=",d,".slice(),",p,"= [];","while(",e,".length) {","if(typeof (",f,"=",e,'.shift()) === "object" &&',f,") {",h,"= [];","if(Array.isArray(",f,")) {",j,"= 0,",n,"=",f,".length;","while(",j,"<",n,") {",l,"=",f,"[",j,"++];",y(h,l),"}","}","else {",m,"= [];"),o(b.prop,m,f,k,l),a.push(y(p,m),"for(",k," in ",f,") {","if(",f,".hasOwnProperty(",k,")) {",l,"=",f,"[",k,"];",y(h,l),"}","}","}",h,".length && ",e,".unshift.apply(",e,",",h,");","}","}",c,"=",p,";"),i(e,f,h,j,k,l,m,n,p)}function q(b,c,d){var e=g(),f=g(),h=g(),j=g(),k=g();a.push(e,"= [];",f,"= 0;",h,"=",d,".length;","while(",f,"<",h,") {",k,"=",d,"[",f,"];"),r(b.arg,j,k),a.push(z(b.arg,j),"&&",e,".push(",k,");","++",f,";","}",c,"=",e,";"),i(e,f,h,k,j)}function r(b,d,e){switch(b.type){case c.PATH:var f=g();k(b,f,"["+e+"]"),a.push(d,"=",f,";"),i(f);break;case c.BINARY_EXPRESSION:C[b.op]?v(b,d,e):s(b,d,e);break;case c.LOGICAL_EXPRESSION:u(b,d,e);break;case c.UNARY_EXPRESSION:w(b,d,e);break;case c.LITERAL:var h=b.val;switch(typeof h){case"string":a.push(d,"=",x(h),";");break;default:a.push(d,"=",h,";")}break;case c.SUBST:a.push(d,"= subst.",b.name,";")}}function s(b,d,e){var f=g(),j=g(),k=g(),l=g(),m=g(),n=g(),o=g(),p=g(),q=h(),s=b.args[0],u=b.args[1];a.push(d,"= false;"),r(s,f,e),r(u,j,e);var v=s.type===c.PATH,w=u.type===c.LITERAL;a.push(k,"="),v?a.push("true;"):a.push("Array.isArray(",f,");"),a.push(l,"="),w?a.push("false;"):a.push("Array.isArray(",j,");"),a.push("if(",k,"&&",f,".length === 1) {",f,"=",f,"[0];",k,"= false;","}"),w||a.push("if(",l,"&&",j,".length === 1) {",j,"=",j,"[0];",l,"= false;","}"),a.push(m,"= 0;","if(",k,") {",o,"=",f,".length;"),w||(a.push("if(",l,") {",p,"=",j,".length;",q,":","while(",m,"<",o,") {",n,"= 0;","while(",n,"<",p,") {"),t(b.op,[f,"[",m,"]"].join(""),[j,"[",n,"]"].join("")),a.push(d,"= true;","break ",q,";","}","++",n,";","}","++",m,";","}","}","else {")),a.push("while(",m,"<",o,") {"),t(b.op,[f,"[",m,"]"].join(""),j),a.push(d,"= true;","break;","}","++",m,";","}"),w||a.push("}"),a.push("}"),w||(a.push("else if(",l,") {",p,"=",j,".length;","while(",m,"<",p,") {"),t(b.op,f,[j,"[",m,"]"].join("")),a.push(d,"= true;","break;","}","++",m,";","}","}")),a.push("else {",d,"=",B[b.op](f,j),";","}"),i(f,j,k,l,m,n,o,p)}function t(b,c,d){a.push("if(",B[b](c,d),") {")}function u(b,c,d){var e=[],f=b.args,h=f.length,j=0,k;a.push(c,"= false;");switch(b.op){case"&&":while(j<h)e.push(k=g()),r(f[j],k,d),a.push("if(",z(f[j++],k),") {");a.push(c,"= true;");break;case"||":while(j<h)e.push(k=g()),r(f[j],k,d),a.push("if(",z(f[j],k),") {",c,"= true;","}"),j++ +1<h&&a.push("else {");--h}while(h--)a.push("}");i.apply(e)}function v(b,c,d){var e=g(),f=g();r(b.args[0],e,d),r(b.args[1],f,d),a.push(c,"=",B[b.op](A(b.args[0],e),A(b.args[1],f)),";"),i(e,f)}function w(b,c,d){var e=g();r(b.arg,e,d);switch(b.op){case"!":a.push(c,"= !",z(b.arg,e)+";");break;case"-":a.push(c,"= -",A(b.arg,e)+";")}i(e)}function x(a){return"'"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"}function y(a,b){return[b,"!= null &&","(Array.isArray(",b,")? ",a,"=",a,".concat(",b,") :",a,".push(",b,")",");"].join("")}function z(a,b){switch(a.type){case c.LOGICAL_EXPRESSION:return b;case c.LITERAL:return"!!"+b;case c.PATH:return b+".length > 0";default:return["(typeof ",b,'=== "boolean"?',b,":","Array.isArray(",b,")?",b,".length > 0 : !!",b,")"].join("")}}function A(a,b){switch(a.type){case c.LITERAL:return b;case c.PATH:return b+"[0]";default:return["(Array.isArray(",b,")?",b,"[0] : ",b,")"].join("")}}var a,b,d,e,f,B={"===":function(a,b){return a+"==="+b},"==":function(a,b){return"typeof "+a+'=== "string" && typeof '+b+'=== "string"?'+a+".toLowerCase() ==="+b+".toLowerCase() :"+a+"=="+b},">=":function(a,b){return a+">="+b},">":function(a,b){return a+">"+b},"<=":function(a,b){return a+"<="+b},"<":function(a,b){return a+"<"+b},"!==":function(a,b){return a+"!=="+b},"!=":function(a,b){return a+"!="+b},"^==":function(a,b){return"typeof "+a+'=== "string" && typeof '+b+'=== "string" &&'+a+".indexOf("+b+") === 0"},"^=":function(a,b){return a+"!== null && "+b+"!== null && "+a+".toString().toLowerCase().indexOf("+b+".toString().toLowerCase()) === 0"},"$==":function(a,b){return"typeof "+a+'=== "string" && typeof '+b+'=== "string" &&'+a+".lastIndexOf("+b+") ==="+a+".length - "+b+".length"},"$=":function(a,b){return"(function(v1, v2) {if(v1 === null || v2 === null) {return false;}var v1s = v1.toString().toLowerCase(),v2s = v2.toString().toLowerCase();return v1s.lastIndexOf(v2s) === v1s.length - v2s.length;})("+a+","+b+")"},"*==":function(a,b){return"typeof "+a+'=== "string" && typeof '+b+'=== "string" &&'+a+".indexOf("+b+") > -1"},"*=":function(a,b){return a+"!== null && "+b+"!== null &&"+a+".toString().toLowerCase().indexOf("+b+".toString().toLowerCase()) > -1"},"+":function(a,b){return a+"+"+b},"-":function(a,b){return a+"-"+b},"*":function(a,b){return a+"*"+b},"/":function(a,b){return a+"/"+b},"%":function(a,b){return a+"%"+b}},C={"+":1,"-":1,"*":1,"/":1,"%":1};return j}();b.compile=f;var g=100,h={},i=[];b.apply=function(a,b,c){return h[a]||(h[a]=f(a),i.push(a)>g&&delete h[i.shift()]),h[a](b,c||{})}});