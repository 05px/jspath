/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* With parts by Marat Dulin (mdevils@gmail.com)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.2.1
*/(function(e){var t;typeof exports=="object"?e(t,exports):typeof define=="function"?define(e):e(t,JSPath={})})(function(e,t){function s(e){return Function("data,subst",i(r(e)))}var n={PATH:1,SELECTOR:2,OBJ_PRED:3,POS_PRED:4,LOGICAL_EXPR:5,BINARY_EXPR:6,UNARY_EXPR:7,ARRAY_EXPR:8,LITERAL:9,SUBST:10},r=function(){function u(t){r=t,i=0,s=null,o=r.length;var n=a(),u=A();return u.type!==e.EOP&&F(u),n}function a(){var e=!1;T("^")&&(A(),e=!0),N()||F(A());var t=[],r;while(i<o){r=f();if(!r)break;t.push(r)}return{type:n.PATH,fromRoot:e,parts:t}}function f(){if(N())return l();if(T("["))return h();if(T("{"))return p()}function l(){var t=A().val,r=k(),i;if(T("*")||r.type===e.ID||r.type===e.STR)i=c();return{type:n.SELECTOR,selector:t,prop:i}}function c(){var t=A(),n=t.type;if(n===e.ID||n===e.STR||n===e.PUNCT&&t.val==="*")return t.val;F(t)}function h(){C("[");var e=w();return C("]"),{type:n.POS_PRED,arg:e}}function p(){C("{");var e=d();return C("}"),{type:n.OBJ_PRED,arg:e}}function d(){var e=v(),t;while(T("||"))A(),(t||(t=[e])).push(v());return t?{type:n.LOGICAL_EXPR,op:"||",args:t}:e}function v(){var e=m(),t;while(T("&&"))A(),(t||(t=[e])).push(m());return t?{type:n.LOGICAL_EXPR,op:"&&",args:t}:e}function m(){var e=g();while(T("==")||T("!=")||T("===")||T("!==")||T("^=")||T("^==")||T("$==")||T("$=")||T("*==")||T("*="))e={type:n.BINARY_EXPR,op:A().val,args:[e,m()]};return e}function g(){var e=y();while(T("<")||T(">")||T("<=")||T(">="))e={type:n.BINARY_EXPR,op:A().val,args:[e,g()]};return e}function y(){var e=b();while(T("+")||T("-"))e={type:n.BINARY_EXPR,op:A().val,args:[e,y()]};return e}function b(){var e=E();while(T("*")||T("/")||T("%"))e={type:n.BINARY_EXPR,op:A().val,args:[e,b()]};return e}function w(){if(T(":"))return A(),{type:n.ARRAY_EXPR,toIdx:E()};var e=E();return T(":")?(A(),T("]")?{type:n.ARRAY_EXPR,fromIdx:e}:{type:n.ARRAY_EXPR,fromIdx:e,toIdx:E()}):{type:n.ARRAY_EXPR,idx:e}}function E(){return T("!")||T("-")?{type:n.UNARY_EXPR,op:A().val,arg:E()}:S()}function S(){var t=k(),r=t.type;return r===e.STR||r===e.NUM||r===e.BOOL?{type:n.LITERAL,val:A().val}:r===e.ID&&t.val[0]==="$"?{type:n.SUBST,name:A().val.substr(1)}:T("^")||N()?a():T("(")?x():F(A())}function x(){C("(");var e=d();return C(")"),e}function T(t){var n=k();return n.type===e.PUNCT&&n.val===t}function N(){var t=k();if(t.type===e.PUNCT){var n=t.val;return n==="."||n===".."}return!1}function C(t){var n=A();(n.type!==e.PUNCT||n.val!==t)&&F(n)}function k(){if(s!==null)return s;var e=i;return s=L(),i=e,s}function L(){while(M(r[i]))++i;if(i>=o)return{type:e.EOP,range:[i,i]};var t=j();if(t||(t=H())||(t=H())||(t=B())||(t=P()))return t;F({val:r[i],range:[i,i]})}function A(){var e;return s?(i=s.range[1],e=s,s=null,e):L()}function O(e){return"0123456789".indexOf(e)>=0}function M(e){return e===" "}function _(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"}function D(e){return _(e)||e>="0"&&e<="9"}function P(){var t=r[i];if(!_(t))return;var n=i,s=t;while(++i<o){t=r[i];if(!D(t))break;s+=t}return s==="true"||s==="false"?{type:e.BOOL,val:s==="true",range:[n,i]}:{type:e.ID,val:s,range:[n,i]}}function H(){if(r[i]!=='"')return;var t=++i,n="",s;while(i<o){s=r[i++];if(s==='"')break;n+=s}return{type:e.STR,val:n,range:[t,i]}}function B(){var t=i,n=r[i],s=n===".";if(s||O(n)){var u=n;while(++i<o){n=r[i];if(n==="."){if(s)return;s=!0}else if(!O(n))break;u+=n}return{type:e.NUM,val:s?parseFloat(u):parseInt(u,10),range:[t,i]}}}function j(){var t=i,n=r[i],s=r[i+1];if(n==="."){if(O(s))return;return r[++i]==="."?{type:e.PUNCT,val:"..",range:[t,++i]}:{type:e.PUNCT,val:".",range:[t,i]}}if(s==="="){var o=r[i+2];if(o==="="){if("=!^$*".indexOf(n)>=0)return{type:e.PUNCT,val:n+s+o,range:[t,i+=3]}}else if("=!^$*><".indexOf(n)>=0)return{type:e.PUNCT,val:n+s,range:[t,i+=2]}}if(n===s&&(n==="|"||n==="&"))return{type:e.PUNCT,val:n+s,range:[t,i+=2]};if(":{}()[]^+-*/%!><".indexOf(n)>=0)return{type:e.PUNCT,val:n,range:[t,++i]}}function F(n){n.type===e.EOP&&I(n,t.UNEXP_EOP),I(n,t.UNEXP_TOKEN,n.val)}function I(e,t){var n=Array.prototype.slice.call(arguments,2),r=t.replace(/%(\d)/g,function(e,t){return n[t]||""}),i=new Error(r);throw i.column=e.range[0],i}var e={ID:1,NUM:2,STR:3,BOOL:4,PUNCT:5,EOP:6},t={UNEXP_TOKEN:'Unexpected token "%0"',UNEXP_EOP:"Unexpected end of path"},r,i,s,o;return u}(),i=function(){function s(){if(i.length)return i.shift();var e="v"+ ++r;return t.push(e),e}function o(){var e=arguments,t=e.length;while(t--)i.push(e[t])}function u(n){return e=[],t=["res"],r=0,i=[],a(n,"res","data",!0),"data = Array.isArray(data)? data : [data];"+(t.length?"var "+t.join(",")+";":"")+e.join("")+"return res;"}function a(t,r,i,u){var a=s(),p=t.parts,d=0,v=p.length,m=!0;e.push(a,"=",t.fromRoot?"data":i,";");while(d<v){var g=p[d++];switch(g.type){case n.SELECTOR:g.selector===".."?l(g,a,a):f(g,a,a);break;case n.OBJ_PRED:c(g,a,a);break;case n.POS_PRED:h(g,a,a)===!1&&u&&d===v&&(m=!1)}}e.push(r,"=",a,m?";":"[0];"),o(a)}function f(t,n,r){if(!t.prop)e.push(n,"=",r,";");else{var i=w(t.prop),u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),p=s();e.push(u,"= [],",a,"= 0,",f,"=",r,".length,",p,"= [];","while(",a,"<",f,") {",l,"=",r,"[",a,"++];","if(",l,"!= null) {"),t.prop==="*"?(e.push("if(Array.isArray(",l,")) {",u,"=",u,".concat(",l,");","}","else {","for(",c," in ",l,") {","if(",l,".hasOwnProperty(",c,")) {",h,"=",l,"[",c,"];"),E(u,h),e.push("}","}","}")):(e.push(h,"=",l,"[",i,"];"),E(u,h,p,f)),e.push("}","}",n,"=",f,"> 1 &&",p,".length?",p,".length > 1?",u,".concat.apply(",u,",",p,") :",u,".concat(",p,"[0]) :",u,";"),o(u,a,f,l,c,h,p)}}function l(t,n,r){var i=t.prop,u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),p=s(),d=s();e.push(u,"=",r,".slice(),",d,"= [];","while(",u,".length) {",a,"=",u,".shift();"),i?e.push("if(typeof ",a,'=== "object" &&',a,") {"):e.push("if(typeof ",a,"!= null) {"),e.push(f,"= [];","if(Array.isArray(",a,")) {",l,"= 0,",p,"=",a,".length;","while(",l,"<",p,") {",h,"=",a,"[",l,"++];"),i&&e.push("if(typeof ",h,'=== "object") {'),E(f,h),i&&e.push("}"),e.push("}","}","else {"),i?i!=="*"&&(e.push(h,"=",a,'["'+i+'"];'),E(d,h)):(E(d,a),e.push("if(typeof ",a,'=== "object") {')),e.push("for(",c," in ",a,") {","if(",a,".hasOwnProperty(",c,")) {",h,"=",a,"[",c,"];"),E(f,h),i==="*"&&E(d,h),e.push("}","}"),i||e.push("}"),e.push("}",f,".length &&",u,".unshift.apply(",u,",",f,");","}","}",n,"=",d,";"),o(u,a,f,l,c,h,p,d)}function c(t,n,r){var i=s(),u=s(),a=s(),f=s(),l=s();e.push(i,"= [];",u,"= 0;",a,"=",r,".length;","while(",u,"<",a,") {",l,"=",r,"[",u,"];"),d(t.arg,f,l),e.push(S(t.arg,f),"&&",i,".push(",l,");","++",u,";","}",n,"=",i,";"),o(i,u,a,l,f)}function h(t,n,r){var i=t.arg,u,a;if(i.idx){var f=s();return d(i.idx,f,r),e.push(f,"=",p(f,r),";",n,"=",r,"[",f,"] == null? [] : [",r,"[",f,"]];"),o(f),!1}i.fromIdx?i.toIdx?(u=s(),a=s(),d(i.fromIdx,u,r),d(i.toIdx,a,r),e.push(u,"=",p(u,r),";",a,"=",p(a,r),";",n,"=",r,".slice(",u,", ",a,");"),o(u,a)):(u=s(),d(i.fromIdx,u,r),e.push(u,"=",p(u,r),";",n,"=",r,".slice(",u,");"),o(u)):(a=s(),d(i.toIdx,a,r),e.push(a,"=",p(a,r),";",n,"=",r,".slice(0, ",a,");"),o(a))}function p(e,t){return[e,"< 0?",t,".length +",e,":",e].join("")}function d(t,r,i){switch(t.type){case n.PATH:var u=s();a(t,u,"["+i+"]"),e.push(r,"=",u,";"),o(u);break;case n.BINARY_EXPR:N[t.op]?y(t,r,i):v(t,r,i);break;case n.LOGICAL_EXPR:g(t,r,i);break;case n.UNARY_EXPR:b(t,r,i);break;case n.LITERAL:var f=t.val;switch(typeof f){case"string":e.push(r,"=",w(f),";");break;default:e.push(r,"=",f,";")}break;case n.SUBST:e.push(r,"= subst.",t.name,";")}}function v(t,r,i){var u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),p=s(),v=s(),g=t.args[0],y=t.args[1];e.push(r,"= false;"),d(g,u,i),d(y,a,i);var b=g.type===n.PATH,w=y.type===n.LITERAL;e.push(f,"="),b?e.push("true;"):e.push("Array.isArray(",u,");"),e.push(l,"="),w?e.push("false;"):e.push("Array.isArray(",a,");"),e.push("if(",f,"&&",u,".length === 1) {",u,"=",u,"[0];",f,"= false;","}"),w||e.push("if(",l,"&&",a,".length === 1) {",a,"=",a,"[0];",l,"= false;","}"),e.push(c,"= 0;","if(",f,") {",p,"=",u,".length;"),w||(e.push("if(",l,") {",v,"=",a,".length;","while(",c,"<",p,"&& !",r,") {",h,"= 0;","while(",h,"<",v,") {"),m(t.op,[u,"[",c,"]"].join(""),[a,"[",h,"]"].join("")),e.push(r,"= true;","break;","}","++",h,";","}","++",c,";","}","}","else {")),e.push("while(",c,"<",p,") {"),m(t.op,[u,"[",c,"]"].join(""),a),e.push(r,"= true;","break;","}","++",c,";","}"),w||e.push("}"),e.push("}"),w||(e.push("else if(",l,") {",v,"=",a,".length;","while(",c,"<",v,") {"),m(t.op,u,[a,"[",c,"]"].join("")),e.push(r,"= true;","break;","}","++",c,";","}","}")),e.push("else {",r,"=",T[t.op](u,a),";","}"),o(u,a,f,l,c,h,p,v)}function m(t,n,r){e.push("if(",T[t](n,r),") {")}function g(t,n,r){var i=[],u=t.args,a=u.length,f=0,l;e.push(n,"= false;");switch(t.op){case"&&":while(f<a)i.push(l=s()),d(u[f],l,r),e.push("if(",S(u[f++],l),") {");e.push(n,"= true;");break;case"||":while(f<a)i.push(l=s()),d(u[f],l,r),e.push("if(",S(u[f],l),") {",n,"= true;","}"),f++ +1<a&&e.push("else {");--a}while(a--)e.push("}");o.apply(i)}function y(t,n,r){var i=s(),u=s();d(t.args[0],i,r),d(t.args[1],u,r),e.push(n,"=",T[t.op](x(t.args[0],i),x(t.args[1],u)),";"),o(i,u)}function b(t,n,r){var i=s();d(t.arg,i,r);switch(t.op){case"!":e.push(n,"= !",S(t.arg,i)+";");break;case"-":e.push(n,"= -",x(t.arg,i)+";")}o(i)}function w(e){return"'"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"}function E(t,n,r,i){e.push("if(",n,"!= null) {","if(Array.isArray(",n,")) {"),r&&e.push(i,"> 1?",r,".push(",n,") :"),e.push(t,"=",t,".concat(",n,");","}","else {"),r&&e.push("if(",r,".length) {",t,"=",t,".concat.apply(",t,",",r,");",r,"= [];","}"),e.push(t,".push(",n,");","}","}")}function S(e,t){switch(e.type){case n.LOGICAL_EXPR:return t;case n.LITERAL:return"!!"+t;case n.PATH:return t+".length > 0";default:return["(typeof ",t,'=== "boolean"?',t,":","Array.isArray(",t,")?",t,".length > 0 : !!",t,")"].join("")}}function x(e,t){switch(e.type){case n.LITERAL:return t;case n.PATH:return t+"[0]";default:return["(Array.isArray(",t,")?",t,"[0] : ",t,")"].join("")}}var e,t,r,i,T={"===":function(e,t){return e+"==="+t},"==":function(e,t){return"typeof "+e+'=== "string" && typeof '+t+'=== "string"?'+e+".toLowerCase() ==="+t+".toLowerCase() :"+e+"=="+t},">=":function(e,t){return e+">="+t},">":function(e,t){return e+">"+t},"<=":function(e,t){return e+"<="+t},"<":function(e,t){return e+"<"+t},"!==":function(e,t){return e+"!=="+t},"!=":function(e,t){return e+"!="+t},"^==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t+'=== "string" &&',e,".indexOf(",t,") === 0"].join("")},"^=":function(e,t){return[e,"!= null &&",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) === 0"].join("")},"$==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".lastIndexOf(",t,") ===",e,".length -",t,".length"].join("")},"$=":function(e,t){return[e,"!= null &&",t,"!= null &&","(",e,"=",e,".toLowerCase().toString()).indexOf(","(",t,"=",t,".toLowerCase().toLowerCase())) ===",e,".length -",t,".length"].join("")},"*==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".indexOf(",t,") > -1"].join("")},"*=":function(e,t){return[e,"!= null && ",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) > -1"].join("")},"+":function(e,t){return e+"+"+t},"-":function(e,t){return e+"-"+t},"*":function(e,t){return e+"*"+t},"/":function(e,t){return e+"/"+t},"%":function(e,t){return e+"%"+t}},N={"+":1,"-":1,"*":1,"/":1,"%":1};return u}(),o={},u=[],a={cacheSize:100},f={cacheSize:function(e,t){if(t<e&&u.length>t){var n=u.splice(0,u.length-t),r=n.length,i=0;while(i<r)delete o[n[i++]]}}};t.params=function(e){if(!arguments.length)return a;for(var t in e)e.hasOwnProperty(t)&&(f[t]&&f[t](a[t],e[t]),a[t]=e[t])},t.compile=s,t.apply=function(e,t,n){return o[e]||(o[e]=s(e),u.push(e)>a.cacheSize&&delete o[u.shift()]),o[e](t,n||{})}});