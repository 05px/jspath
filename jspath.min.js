/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* With parts by Marat Dulin (mdevils@gmail.com)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.2.4
*/(function(e){var t;typeof exports=="object"?e(t,exports):typeof define=="function"?define(e):e(t,JSPath={})})(function(e,t){function s(e){return Function("data,subst",i(r(e)))}var n={PATH:1,SELECTOR:2,OBJ_PRED:3,POS_PRED:4,LOGICAL_EXPR:5,COMPARISON_EXPR:6,MATH_EXPR:7,CONCAT_EXPR:8,UNARY_EXPR:9,POS_EXPR:10,LITERAL:11,SUBST:12},r=function(){function u(t){r=t.split(""),i=0,s=null,o=r.length;var n=a(),u=M();return u.type!==e.EOP&&q(u),n}function a(){C()||q(M());var e=!1;N("^")&&(M(),e=!0);var t=[],r;while(i<o){r=f();if(!r)break;t.push(r)}return{type:n.PATH,fromRoot:e,parts:t}}function f(){if(k())return l();if(N("["))return h();if(N("{"))return p();if(N("("))return T()}function l(){var t=M().val,r=A(),i;if(N("*")||r.type===e.ID||r.type===e.STR)i=c();return{type:n.SELECTOR,selector:t,prop:i}}function c(){var t=M(),n=t.type;if(n===e.ID||n===e.STR||n===e.PUNCT&&t.val==="*")return t.val;q(t)}function h(){L("[");var e=w();return L("]"),{type:n.POS_PRED,arg:e}}function p(){L("{");var e=d();return L("}"),{type:n.OBJ_PRED,arg:e}}function d(){var e=v(),t;while(N("||"))M(),(t||(t=[e])).push(v());return t?{type:n.LOGICAL_EXPR,op:"||",args:t}:e}function v(){var e=m(),t;while(N("&&"))M(),(t||(t=[e])).push(m());return t?{type:n.LOGICAL_EXPR,op:"&&",args:t}:e}function m(){var e=g();while(N("==")||N("!=")||N("===")||N("!==")||N("^=")||N("^==")||N("$==")||N("$=")||N("*==")||N("*="))e={type:n.COMPARISON_EXPR,op:M().val,args:[e,m()]};return e}function g(){var e=y();while(N("<")||N(">")||N("<=")||N(">="))e={type:n.COMPARISON_EXPR,op:M().val,args:[e,g()]};return e}function y(){var e=b();while(N("+")||N("-"))e={type:n.MATH_EXPR,op:M().val,args:[e,y()]};return e}function b(){var e=E();while(N("*")||N("/")||N("%"))e={type:n.MATH_EXPR,op:M().val,args:[e,b()]};return e}function w(){if(N(":"))return M(),{type:n.POS_EXPR,toIdx:E()};var e=E();return N(":")?(M(),N("]")?{type:n.POS_EXPR,fromIdx:e}:{type:n.POS_EXPR,fromIdx:e,toIdx:E()}):{type:n.POS_EXPR,idx:e}}function E(){return N("!")||N("-")?{type:n.UNARY_EXPR,op:M().val,arg:E()}:S()}function S(){var t=A(),r=t.type;return r===e.STR||r===e.NUM||r===e.BOOL?{type:n.LITERAL,val:M().val}:r===e.ID&&t.val[0]==="$"?{type:n.SUBST,name:M().val.substr(1)}:C()?a():N("(")?x():q(M())}function x(){L("(");var e=d();return L(")"),e}function T(){L("(");var e=a(),t;while(N("|"))M(),(t||(t=[e])).push(a());return L(")"),t?{type:n.CONCAT_EXPR,op:"|",args:t}:e}function N(t){var n=A();return n.type===e.PUNCT&&n.val===t}function C(){return k()||N("^")}function k(){var t=A();if(t.type===e.PUNCT){var n=t.val;return n==="."||n===".."}return!1}function L(t){var n=M();(n.type!==e.PUNCT||n.val!==t)&&q(n)}function A(){if(s!==null)return s;var e=i;return s=O(),i=e,s}function O(){while(D(r[i]))++i;if(i>=o)return{type:e.EOP,range:[i,i]};var t=I();if(t||(t=j())||(t=j())||(t=F())||(t=B()))return t;q({val:r[i],range:[i,i]})}function M(){var e;return s?(i=s.range[1],e=s,s=null,e):O()}function _(e){return"0123456789".indexOf(e)>=0}function D(e){return e===" "}function P(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"}function H(e){return P(e)||e>="0"&&e<="9"}function B(){var t=r[i];if(!P(t))return;var n=i,s=t;while(++i<o){t=r[i];if(!H(t))break;s+=t}return s==="true"||s==="false"?{type:e.BOOL,val:s==="true",range:[n,i]}:{type:e.ID,val:s,range:[n,i]}}function j(){if(r[i]!=='"')return;var t=++i,n="",s;while(i<o){s=r[i++];if(s==='"')break;n+=s}return{type:e.STR,val:n,range:[t,i]}}function F(){var t=i,n=r[i],s=n===".";if(s||_(n)){var u=n;while(++i<o){n=r[i];if(n==="."){if(s)return;s=!0}else if(!_(n))break;u+=n}return{type:e.NUM,val:s?parseFloat(u):parseInt(u,10),range:[t,i]}}}function I(){var t=i,n=r[i],s=r[i+1];if(n==="."){if(_(s))return;return r[++i]==="."?{type:e.PUNCT,val:"..",range:[t,++i]}:{type:e.PUNCT,val:".",range:[t,i]}}if(s==="="){var o=r[i+2];if(o==="="){if("=!^$*".indexOf(n)>=0)return{type:e.PUNCT,val:n+s+o,range:[t,i+=3]}}else if("=!^$*><".indexOf(n)>=0)return{type:e.PUNCT,val:n+s,range:[t,i+=2]}}if(n===s&&(n==="|"||n==="&"))return{type:e.PUNCT,val:n+s,range:[t,i+=2]};if(":{}()[]^+-*/%!><|".indexOf(n)>=0)return{type:e.PUNCT,val:n,range:[t,++i]}}function q(n){n.type===e.EOP&&R(n,t.UNEXP_EOP),R(n,t.UNEXP_TOKEN,n.val)}function R(e,t){var n=Array.prototype.slice.call(arguments,2),r=t.replace(/%(\d)/g,function(e,t){return n[t]||""}),i=new Error(r);throw i.column=e.range[0],i}var e={ID:1,NUM:2,STR:3,BOOL:4,PUNCT:5,EOP:6},t={UNEXP_TOKEN:'Unexpected token "%0"',UNEXP_EOP:"Unexpected end of path"},r,i,s,o;return u}(),i=function(){function s(){if(i.length)return i.shift();var e="v"+ ++r;return t.push(e),e}function o(){var e=arguments,t=e.length;while(t--)i.push(e[t])}function u(n){return e=[],t=["res"],r=0,i=[],a(n,"res","data",!0),e.unshift("var ",Array.isArray?"isArr = Array.isArray":'toStr = Object.prototype.toString, isArr = function(o) { return toStr.call(o) === "[object Array]"; }',",",t.join(","),";","isArr(data) || (data = [data]);"),e.push("return res;"),e.join("")}function a(t,r,i,u){var a=s(),p=t.parts,d=0,v=p.length,m=!0;e.push(a,"=",t.fromRoot?"data":i,";");while(d<v){var g=p[d++];switch(g.type){case n.SELECTOR:g.selector===".."?l(g,a,a):f(g,a,a);break;case n.OBJ_PRED:c(g,a,a);break;case n.POS_PRED:h(g,a,a)===!1&&u&&d===v&&(m=!1);break;case n.CONCAT_EXPR:b(g,a,a)}}e.push(r,"=",a,m?";":"[0];"),o(a)}function f(t,n,r){if(t.prop){var i=w(t.prop),u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),p=s();e.push(u,"= [],",a,"= 0,",f,"=",r,".length,",p,"= [];","while(",a,"<",f,") {",l,"=",r,"[",a,"++];","if(",l,"!= null) {"),t.prop==="*"?(e.push("if(isArr(",l,")) {",u,"=",u,".concat(",l,");","}","else {","for(",c," in ",l,") {","if(",l,".hasOwnProperty(",c,")) {",h,"=",l,"[",c,"];"),E(u,h),e.push("}","}","}")):(e.push(h,"=",l,"[",i,"];"),E(u,h,p,f)),e.push("}","}",n,"=",f,"> 1 &&",p,".length?",p,".length > 1?",u,".concat.apply(",u,",",p,") :",u,".concat(",p,"[0]) :",u,";"),o(u,a,f,l,c,h,p)}}function l(t,n,r){var i=t.prop,u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),p=s(),d=s();e.push(u,"=",r,".slice(),",d,"= [];","while(",u,".length) {",a,"=",u,".shift();"),i?e.push("if(typeof ",a,'=== "object" &&',a,") {"):e.push("if(typeof ",a,"!= null) {"),e.push(f,"= [];","if(isArr(",a,")) {",l,"= 0,",p,"=",a,".length;","while(",l,"<",p,") {",h,"=",a,"[",l,"++];"),i&&e.push("if(typeof ",h,'=== "object") {'),E(f,h),i&&e.push("}"),e.push("}","}","else {"),i?i!=="*"&&(e.push(h,"=",a,'["'+i+'"];'),E(d,h)):(E(d,a),e.push("if(typeof ",a,'=== "object") {')),e.push("for(",c," in ",a,") {","if(",a,".hasOwnProperty(",c,")) {",h,"=",a,"[",c,"];"),E(f,h),i==="*"&&E(d,h),e.push("}","}"),i||e.push("}"),e.push("}",f,".length &&",u,".unshift.apply(",u,",",f,");","}","}",n,"=",d,";"),o(u,a,f,l,c,h,p,d)}function c(t,n,r){var i=s(),u=s(),a=s(),f=s(),l=s();e.push(i,"= [];",u,"= 0;",a,"=",r,".length;","while(",u,"<",a,") {",l,"=",r,"[",u,"];"),p(t.arg,f,l),e.push(S(t.arg,f),"&&",i,".push(",l,");","++",u,";","}",n,"=",i,";"),o(i,u,a,l,f)}function h(t,n,r){var i=t.arg,u,a;if(i.idx){var f=s();return p(i.idx,f,r),e.push(f,"< 0 && (",f,"=",r,".length +",f,");",n,"=",r,"[",f,"] == null? [] : [",r,"[",f,"]];"),o(f),!1}i.fromIdx?i.toIdx?(p(i.fromIdx,u=s(),r),p(i.toIdx,a=s(),r),e.push(n,"=",r,".slice(",u,", ",a,");"),o(u,a)):(p(i.fromIdx,u=s(),r),e.push(n,"=",r,".slice(",u,");"),o(u)):(p(i.toIdx,a=s(),r),e.push(n,"=",r,".slice(0, ",a,");"),o(a))}function p(t,r,i){switch(t.type){case n.PATH:var u=s();a(t,u,"["+i+"]"),e.push(r,"=",u,";"),o(u);break;case n.COMPARISON_EXPR:d(t,r,i);break;case n.MATH_EXPR:g(t,r,i);break;case n.LOGICAL_EXPR:m(t,r,i);break;case n.UNARY_EXPR:y(t,r,i);break;case n.LITERAL:var f=t.val;switch(typeof f){case"string":e.push(r,"=",w(f),";");break;default:e.push(r,"=",f,";")}break;case n.SUBST:e.push(r,"= subst.",t.name,";")}}function d(t,r,i){var u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),d=s(),m=s(),g=t.args[0],y=t.args[1];e.push(r,"= false;"),p(g,u,i),p(y,a,i);var b=g.type===n.PATH,w=y.type===n.LITERAL;e.push(f,"="),b?e.push("true;"):e.push("isArr(",u,");"),e.push(l,"="),w?e.push("false;"):e.push("isArr(",a,");"),e.push("if("),b||e.push(f,"&&"),e.push(u,".length === 1) {",u,"=",u,"[0];",f,"= false;","}"),w||e.push("if(",l,"&&",a,".length === 1) {",a,"=",a,"[0];",l,"= false;","}"),e.push(c,"= 0;","if(",f,") {",d,"=",u,".length;"),w||(e.push("if(",l,") {",m,"=",a,".length;","while(",c,"<",d,"&& !",r,") {",h,"= 0;","while(",h,"<",m,") {"),v(t.op,[u,"[",c,"]"].join(""),[a,"[",h,"]"].join("")),e.push(r,"= true;","break;","}","++",h,";","}","++",c,";","}","}","else {")),e.push("while(",c,"<",d,") {"),v(t.op,[u,"[",c,"]"].join(""),a),e.push(r,"= true;","break;","}","++",c,";","}"),w||e.push("}"),e.push("}"),w||(e.push("else if(",l,") {",m,"=",a,".length;","while(",c,"<",m,") {"),v(t.op,u,[a,"[",c,"]"].join("")),e.push(r,"= true;","break;","}","++",c,";","}","}")),e.push("else {",r,"=",T[t.op](u,a),";","}"),o(u,a,f,l,c,h,d,m)}function v(t,n,r){e.push("if(",T[t](n,r),") {")}function m(t,n,r){var i=[],u=t.args,a=u.length,f=0,l;e.push(n,"= false;");switch(t.op){case"&&":while(f<a)i.push(l=s()),p(u[f],l,r),e.push("if(",S(u[f++],l),") {");e.push(n,"= true;");break;case"||":while(f<a)i.push(l=s()),p(u[f],l,r),e.push("if(",S(u[f],l),") {",n,"= true;","}"),f++ +1<a&&e.push("else {");--a}while(a--)e.push("}");o.apply(i)}function g(t,n,r){var i=s(),u=s(),a=t.args;p(a[0],i,r),p(a[1],u,r),e.push(n,"=",T[t.op](x(a[0],i),x(a[1],u)),";"),o(i,u)}function y(t,n,r){var i=s(),u=t.arg;p(u,i,r);switch(t.op){case"!":e.push(n,"= !",S(u,i)+";");break;case"-":e.push(n,"= -",x(u,i)+";")}o(i)}function b(t,n,r){var i=[],u=t.args,f=u.length,l=0;while(l<f)i.push(s()),a(u[l],i[l++],r);e.push(n,"= (",n,"= []).concat.call(",n,",",i.join(","),");"),o.apply(i)}function w(e){return"'"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"}function E(t,n,r,i){e.push("if(",n,"!= null) {","if(isArr(",n,")) {"),r&&e.push(i,"> 1?",r,".push(",n,") :"),e.push(t,"=",t,".concat(",n,");","}","else {"),r&&e.push("if(",r,".length) {",t,"=",t,".concat.apply(",t,",",r,");",r,"= [];","}"),e.push(t,".push(",n,");","}","}")}function S(e,t){switch(e.type){case n.LOGICAL_EXPR:return t;case n.LITERAL:return"!!"+t;case n.PATH:return t+".length > 0";default:return["(typeof ",t,'=== "boolean"?',t,":","isArr(",t,")?",t,".length > 0 : !!",t,")"].join("")}}function x(e,t){switch(e.type){case n.LITERAL:return t;case n.PATH:return t+"[0]";default:return["(isArr(",t,")?",t,"[0] : ",t,")"].join("")}}var e,t,r,i,T={"===":function(e,t){return e+"==="+t},"==":function(e,t){return"typeof "+e+'=== "string" && typeof '+t+'=== "string"?'+e+".toLowerCase() ==="+t+".toLowerCase() :"+e+"=="+t},">=":function(e,t){return e+">="+t},">":function(e,t){return e+">"+t},"<=":function(e,t){return e+"<="+t},"<":function(e,t){return e+"<"+t},"!==":function(e,t){return e+"!=="+t},"!=":function(e,t){return e+"!="+t},"^==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t+'=== "string" &&',e,".indexOf(",t,") === 0"].join("")},"^=":function(e,t){return[e,"!= null &&",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) === 0"].join("")},"$==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".lastIndexOf(",t,") ===",e,".length -",t,".length"].join("")},"$=":function(e,t){return[e,"!= null &&",t,"!= null &&","(",e,"=",e,".toLowerCase().toString()).indexOf(","(",t,"=",t,".toLowerCase().toLowerCase())) ===",e,".length -",t,".length"].join("")},"*==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".indexOf(",t,") > -1"].join("")},"*=":function(e,t){return[e,"!= null && ",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) > -1"].join("")},"+":function(e,t){return e+"+"+t},"-":function(e,t){return e+"-"+t},"*":function(e,t){return e+"*"+t},"/":function(e,t){return e+"/"+t},"%":function(e,t){return e+"%"+t}};return u}(),o={},u=[],a={cacheSize:100},f={cacheSize:function(e,t){if(t<e&&u.length>t){var n=u.splice(0,u.length-t),r=n.length,i=0;while(i<r)delete o[n[i++]]}}};t.params=function(e){if(!arguments.length)return a;for(var t in e)e.hasOwnProperty(t)&&(f[t]&&f[t](a[t],e[t]),a[t]=e[t])},t.compile=s,t.apply=function(e,t,n){return o[e]||(o[e]=s(e),u.push(e)>a.cacheSize&&delete o[u.shift()]),o[e](t,n||{})}});