/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.0.1
*/(function(e){var t;typeof exports=="object"?e(t,exports):typeof define=="function"?define(e):e(t,JSPath={})})(function(e,t){function a(e){i=e,s=0,o=null,u=i.length;var t=f(),r=A();return r.type!==n.EOP&&I(r),t}function f(){var e=!1;T("^")&&(A(),e=!0),N()||I(A());var t=[],n;while(s<u){n=l();if(!n)break;t.push(n)}return e?function(e,n,r){return R(n,n,r,t)}:function(e,n,r){return R(e,n,r,t)}}function l(){if(N()){var e=A().val,t=k(),r;if(T("*")||e===".."||t.type===n.ID||t.type===n.STRING)r=c();return e===".."?function(e){return W(e,r)}:r?function(e){return z(e,r)}:U}if(T("["))return h();if(T("{"))return p()}function c(){var e=A(),t=e.type;if(t===n.ID||t===n.STRING||t===n.PUNCTUATOR&&e.val==="*")return e.val;I(e)}function h(){C("[");var e=w();return C("]"),e}function p(){C("{");var e=d();return C("}"),function(t,n,r){var i=[],s=0,o=t.length,u;while(s<o)V(e(u=t[s++],n,r))&&i.push(u);return i}}function d(){var e=v(),t;while(T("||"))A(),(t||(t=[e])).push(v());return t?function(e,n,r){var i=0,s;while(s=t[i++])if(V(s(e,n,r)))return!0;return!1}:e}function v(){var e=m(),t;while(T("&&"))A(),(t||(t=[e])).push(m());return t?function(e,n,r){var i=0,s;while(s=t[i++])if(!V(s(e,n,r)))return!1;return!0}:e}function m(){var e=g(),t;while(T("==")||T("!=")||T("===")||T("!==")||T("^=")||T("^==")||T("$==")||T("$=")||T("*==")||T("*="))(t||(t=[e])).push($[A().val],g());return t?J(t,K):e}function g(){var e=y(),t;while(T("<")||T(">")||T("<=")||T(">="))(t||(t=[e])).push($[A().val],y());return t?J(t,K):e}function y(){var e=b(),t;while(T("+")||T("-"))(t||(t=[e])).push($[A().val],b());return t?J(t,Q):e}function b(){var e=E(),t;while(T("*")||T("/")||T("%"))(t||(t=[e])).push($[A().val],E());return t?J(t,Q):e}function w(){if(T(":")){A();var e=E();return function(t,n,r){return t.slice(0,e(t,n,r))}}var t=E();if(T(":")){A();if(T("]"))return function(e,n,r){return e.slice(t(e,n,r))};var e=E();return function(n,r,i){return n.slice(t(n,r,i),e(n,r,i))}}return function(e,n,r){var i=t(e,n,r),s=i>=0?e[i]:e[e.length+i];return typeof s=="undefined"?s:[s]}}function E(){if(T("!")){A();var e=E();return function(t,n,r){return!V(e(t,n,r))}}if(T("-")){A();var e=E();return function(t,n,r){return-e(t,n,r)}}return S()}function S(){var e=k(),t=e.type;if(t===n.STRING||t===n.NUMERIC||t===n.BOOLEAN){var r=A().val;return function(){return r}}if(t===n.ID&&e.val[0]==="$"){var i=A().val.substr(1);return function(e,t,n){return n[i]}}return T("^")||N()?f():T("(")?x():I(A())}function x(){C("(");var e=d();return C(")"),e}function T(e){var t=k();return t.type===n.PUNCTUATOR&&t.val===e}function N(){var e=k();if(e.type===n.PUNCTUATOR){var t=e.val;return t==="."||t===".."}return!1}function C(e){var t=A();(t.type!==n.PUNCTUATOR||t.val!==e)&&I(t)}function k(){var e;return o!==null?o:(e=s,o=L(),s=e,o)}function L(){while(_(i[s]))++s;if(s>=u)return{type:n.EOP,range:[s,s]};var e=F();if(e)return e;e=B();if(e)return e;e=j();if(e)return e;e=H();if(e)return e;I({val:i[s],range:[s,s]})}function A(){var e;return o?(s=o.range[1],e=o,o=null,e):(o=null,L())}function O(){return i[s++]}function M(e){return"0123456789".indexOf(e)>=0}function _(e){return e===" "}function D(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"}function P(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"}function H(){var e=i[s];if(!D(e))return;var t=s,r=O();while(s<u){e=i[s];if(!P(e))break;r+=O()}return r==="true"||r==="false"?{type:n.BOOLEAN,val:r==="true",range:[t,s]}:{type:n.ID,val:r,range:[t,s]}}function B(){if(i[s]!=='"')return;var e=++s,t="",r;while(s<u){r=O();if(r==='"')break;t+=r}return{type:n.STRING,val:t,range:[e,s]}}function j(){var e=s,t=i[s],r=t===".";if(r||M(t)){var o=t;while(++s<u){t=i[s];if(t==="."){if(r)return;r=!0}else if(!M(t))break;o+=t}return{type:n.NUMERIC,val:r?parseFloat(o):parseInt(o,10),range:[e,s]}}}function F(){var e=s,t=i[s],r=i[s+1];if(t==="."){if(M(r))return;return i[++s]==="."?{type:n.PUNCTUATOR,val:"..",range:[e,++s]}:{type:n.PUNCTUATOR,val:".",range:[e,s]}}if(r==="="){var o=i[s+2];if(o==="="){if("=!^$*".indexOf(t)>=0)return{type:n.PUNCTUATOR,val:t+r+o,range:[e,s+=3]}}else if("=!^$*><".indexOf(t)>=0)return{type:n.PUNCTUATOR,val:t+r,range:[e,s+=2]}}if(t===r&&(t==="|"||t==="&"))return{type:n.PUNCTUATOR,val:t+r,range:[e,s+=2]};if(":{}()[]^+-*/%!><".indexOf(t)>=0)return{type:n.PUNCTUATOR,val:t,range:[e,++s]}}function I(e){e.type===n.EOP&&q(e,r.UNEXPECTED_EOP),q(e,r.UNEXPECTED_TOKEN,e.val)}function q(e,t){var n=Array.prototype.slice.call(arguments,2),r=t.replace(/%(\d)/g,function(e,t){return n[t]||""}),i=new Error(r);throw i.column=e.range[0],i}function R(e,t,n,r){var i,s=0,o=Array.isArray(e)?e:[e];while(i=r[s++]){o=i(o,t,n);if(!o||!o.length)return[]}return o}function U(e){return e}function z(e,t){var n,r=0,i=e.length,s;while(r<i)s=e[r++],typeof s=="object"&&s!==null&&(n=X(n,t==="*"?Object.keys(s).map(function(e){return s[e]}):s[t]));return n}function W(e,t,n){var e=e.slice(),r,i,s,o,u,a;while(e.length){if(typeof (i=e.shift())!="object"||i===null)continue;s=n;if(Array.isArray(i)){o=0,u=i.length;while(o<u)s=X(s,i[o]),++o}else{r=X(r,z([i],t)),a=Object.keys(i),o=0,u=a.length;while(o<u)s=X(s,i[a[o]]),++o}s&&e.unshift.apply(e,s)}return r}function X(e,t){return typeof t=="undefined"?e:e?Array.isArray(t)?e.concat(t):(e.push(t),e):Array.isArray(t)?t:[t]}function V(e){return Array.isArray(e)?!!e.length:!!e}function J(e,t){return function(n,r,i){var s=e,o=1,u=s.length-1,a=s[0](n,r,i);while(o<u)a=t(a,s[o+1](n,r,i),s[o]),o+=2;return a}}function K(e,t,n){var r=Array.isArray(e),i=Array.isArray(t);return r&&e.length===1&&(e=e[0],r=!1),i&&t.length===1&&(t=t[0],i=!1),r?i?e.some(function(e){return t.some(function(t){return n(e,t)})}):e.some(function(e){return n(e,t)}):i?t.some(function(t){return n(e,t)}):n(e,t)}function Q(e,t,n){return n(Array.isArray(e)?e[0]:e,Array.isArray(t)?t[0]:t)}var n={ID:1,NUMERIC:2,STRING:3,BOOLEAN:4,PUNCTUATOR:5,EOP:6},r={UNEXPECTED_TOKEN:'Unexpected token "%0"',UNEXPECTED_EOP:"Unexpected end of path"},i,s,o,u,$={"===":function(e,t){return e===t},"==":function(e,t){return typeof e=="string"&&typeof t=="string"?e.toLowerCase()===t.toLowerCase():e==t},">=":function(e,t){return e>=t},">":function(e,t){return e>t},"<=":function(e,t){return e<=t},"<":function(e,t){return e<t},"!==":function(e,t){return e!==t},"!=":function(e,t){return e!=t},"^==":function(e,t){return typeof e=="string"&&typeof t=="string"&&e.indexOf(t)===0},"^=":function(e,t){return e!==null&&t!==null&&e.toString().toLowerCase().indexOf(t.toString().toLowerCase())===0},"$==":function(e,t){return typeof e=="string"&&typeof t=="string"&&e.indexOf(t,e.length-t.length)>-1},"$=":function(e,t){if(e===null||t===null)return!1;var n=e.toString().toLowerCase(),r=t.toString().toLowerCase();return n.indexOf(r,n.length-r.length)>-1},"*==":function(e,t){return typeof e=="string"&&typeof t=="string"&&e.indexOf(t)>-1},"*=":function(e,t){return e!==null&&t!==null&&e.toString().toLowerCase().indexOf(t.toString().toLowerCase())>-1},"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"%":function(e,t){return e%t}};t._parse=a;var G={};t.apply=function(e,t,n){return(G[e]||(G[e]=a(e)))(t,t,n||{})}});