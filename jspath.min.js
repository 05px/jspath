/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.0.5
*/(function(e){var t;typeof exports=="object"?e(t,exports):typeof define=="function"?define(e):e(t,JSPath={})})(function(e,t){function a(e){i=e,s=0,o=null,u=i.length;var t=f(),r=O();return r.type!==n.EOP&&q(r),t}function f(){var e=!1;N("^")&&(O(),e=!0),C()||q(O());var t=[],n;while(s<u){n=l();if(!n)break;t.push(n)}return e?function(e,n,r){return U(n,n,r,t)}:function(e,n,r){return U(e,n,r,t)}}function l(){if(C())return c();if(N("["))return p();if(N("{"))return d()}function c(){var e=O().val,t=L(),r;if(N("*")||e===".."||t.type===n.ID||t.type===n.STRING)r=h();return e===".."?function(e){return X(e,r)}:r?function(e){return W(e,r)}:z}function h(){var e=O(),t=e.type;if(t===n.ID||t===n.STRING||t===n.PUNCTUATOR&&e.val==="*")return e.val;q(e)}function p(){k("[");var e=E();return k("]"),e}function d(){k("{");var e=v();return k("}"),function(t,n,r){var i=[],s=0,o=t.length,u;while(s<o)$(e(u=t[s++],n,r))&&i.push(u);return i}}function v(){var e=m(),t;while(N("||"))O(),(t||(t=[e])).push(m());return t?function(e,n,r){var i=0,s;while(s=t[i++])if($(s(e,n,r)))return!0;return!1}:e}function m(){var e=g(),t;while(N("&&"))O(),(t||(t=[e])).push(g());return t?function(e,n,r){var i=0,s;while(s=t[i++])if(!$(s(e,n,r)))return!1;return!0}:e}function g(){var e=y(),t;while(N("==")||N("!=")||N("===")||N("!==")||N("^=")||N("^==")||N("$==")||N("$=")||N("*==")||N("*="))(t||(t=[e])).push(J[O().val],y());return t?K(t,Q):e}function y(){var e=b(),t;while(N("<")||N(">")||N("<=")||N(">="))(t||(t=[e])).push(J[O().val],b());return t?K(t,Q):e}function b(){var e=w(),t;while(N("+")||N("-"))(t||(t=[e])).push(J[O().val],w());return t?K(t,G):e}function w(){var e=S(),t;while(N("*")||N("/")||N("%"))(t||(t=[e])).push(J[O().val],S());return t?K(t,G):e}function E(){if(N(":")){O();var e=S();return function(t,n,r){return t.slice(0,e(t,n,r))}}var t=S();if(N(":")){O();if(N("]"))return function(e,n,r){return e.slice(t(e,n,r))};var e=S();return function(n,r,i){return n.slice(t(n,r,i),e(n,r,i))}}return function(e,n,r){var i=t(e,n,r),s=i>=0?e[i]:e[e.length+i];return typeof s=="undefined"?s:[s]}}function S(){if(N("!")){O();var e=S();return function(t,n,r){return!$(e(t,n,r))}}if(N("-")){O();var e=S();return function(t,n,r){return-e(t,n,r)}}return x()}function x(){var e=L(),t=e.type;if(t===n.STRING||t===n.NUMERIC||t===n.BOOLEAN){var r=O().val;return function(){return r}}if(t===n.ID&&e.val[0]==="$"){var i=O().val.substr(1);return function(e,t,n){return n[i]}}return N("^")||C()?f():N("(")?T():q(O())}function T(){k("(");var e=v();return k(")"),e}function N(e){var t=L();return t.type===n.PUNCTUATOR&&t.val===e}function C(){var e=L();if(e.type===n.PUNCTUATOR){var t=e.val;return t==="."||t===".."}return!1}function k(e){var t=O();(t.type!==n.PUNCTUATOR||t.val!==e)&&q(t)}function L(){var e;return o!==null?o:(e=s,o=A(),s=e,o)}function A(){while(D(i[s]))++s;if(s>=u)return{type:n.EOP,range:[s,s]};var e=I();if(e)return e;e=j();if(e)return e;e=F();if(e)return e;e=B();if(e)return e;q({val:i[s],range:[s,s]})}function O(){var e;return o?(s=o.range[1],e=o,o=null,e):(o=null,A())}function M(){return i[s++]}function _(e){return"0123456789".indexOf(e)>=0}function D(e){return e===" "}function P(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"}function H(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"}function B(){var e=i[s];if(!P(e))return;var t=s,r=M();while(s<u){e=i[s];if(!H(e))break;r+=M()}return r==="true"||r==="false"?{type:n.BOOLEAN,val:r==="true",range:[t,s]}:{type:n.ID,val:r,range:[t,s]}}function j(){if(i[s]!=='"')return;var e=++s,t="",r;while(s<u){r=M();if(r==='"')break;t+=r}return{type:n.STRING,val:t,range:[e,s]}}function F(){var e=s,t=i[s],r=t===".";if(r||_(t)){var o=t;while(++s<u){t=i[s];if(t==="."){if(r)return;r=!0}else if(!_(t))break;o+=t}return{type:n.NUMERIC,val:r?parseFloat(o):parseInt(o,10),range:[e,s]}}}function I(){var e=s,t=i[s],r=i[s+1];if(t==="."){if(_(r))return;return i[++s]==="."?{type:n.PUNCTUATOR,val:"..",range:[e,++s]}:{type:n.PUNCTUATOR,val:".",range:[e,s]}}if(r==="="){var o=i[s+2];if(o==="="){if("=!^$*".indexOf(t)>=0)return{type:n.PUNCTUATOR,val:t+r+o,range:[e,s+=3]}}else if("=!^$*><".indexOf(t)>=0)return{type:n.PUNCTUATOR,val:t+r,range:[e,s+=2]}}if(t===r&&(t==="|"||t==="&"))return{type:n.PUNCTUATOR,val:t+r,range:[e,s+=2]};if(":{}()[]^+-*/%!><".indexOf(t)>=0)return{type:n.PUNCTUATOR,val:t,range:[e,++s]}}function q(e){e.type===n.EOP&&R(e,r.UNEXPECTED_EOP),R(e,r.UNEXPECTED_TOKEN,e.val)}function R(e,t){var n=Array.prototype.slice.call(arguments,2),r=t.replace(/%(\d)/g,function(e,t){return n[t]||""}),i=new Error(r);throw i.column=e.range[0],i}function U(e,t,n,r){var i,s=0,o=Array.isArray(e)?e:[e];while(i=r[s++]){o=i(o,t,n);if(!o||!o.length)return[]}return o}function z(e){return e}function W(e,t){var n=[],r=0,i=e.length,s,o,u,a,f=t==="*";while(r<i){s=e[r++];if(s!=null)if(f){o=Object.keys(s),a=0,u=o.length;while(a<u)n=V(n,s[o[a++]])}else n=V(n,s[t])}return n}function X(e,t,n){e=e.slice();var r=[],i,s,o,u,a;while(e.length){if(typeof (i=e.shift())!="object"||i===null)continue;s=[];if(Array.isArray(i)){o=0,u=i.length;while(o<u)s=V(s,i[o++])}else{r=V(r,W([i],t)),a=Object.keys(i),o=0,u=a.length;while(o<u)s=V(s,i[a[o++]])}s.length&&e.unshift.apply(e,s)}return r}function V(e,t){return typeof t!="undefined"&&(Array.isArray(t)?e=e.concat(t):e.push(t)),e}function $(e){return Array.isArray(e)?!!e.length:!!e}function K(e,t){return function(n,r,i){var s=e,o=1,u=s.length-1,a=s[0](n,r,i);while(o<u)a=t(a,s[o+1](n,r,i),s[o]),o+=2;return a}}function Q(e,t,n){var r=Array.isArray(e),i=Array.isArray(t);return r&&e.length===1&&(e=e[0],r=!1),i&&t.length===1&&(t=t[0],i=!1),r?i?e.some(function(e){return t.some(function(t){return n(e,t)})}):e.some(function(e){return n(e,t)}):i?t.some(function(t){return n(e,t)}):n(e,t)}function G(e,t,n){return n(Array.isArray(e)?e[0]:e,Array.isArray(t)?t[0]:t)}var n={ID:1,NUMERIC:2,STRING:3,BOOLEAN:4,PUNCTUATOR:5,EOP:6},r={UNEXPECTED_TOKEN:'Unexpected token "%0"',UNEXPECTED_EOP:"Unexpected end of path"},i,s,o,u,J={"===":function(e,t){return e===t},"==":function(e,t){return typeof e=="string"&&typeof t=="string"?e.toLowerCase()===t.toLowerCase():e==t},">=":function(e,t){return e>=t},">":function(e,t){return e>t},"<=":function(e,t){return e<=t},"<":function(e,t){return e<t},"!==":function(e,t){return e!==t},"!=":function(e,t){return e!=t},"^==":function(e,t){return typeof e=="string"&&typeof t=="string"&&e.indexOf(t)===0},"^=":function(e,t){return e!==null&&t!==null&&e.toString().toLowerCase().indexOf(t.toString().toLowerCase())===0},"$==":function(e,t){return typeof e=="string"&&typeof t=="string"&&e.indexOf(t,e.length-t.length)>-1},"$=":function(e,t){if(e===null||t===null)return!1;var n=e.toString().toLowerCase(),r=t.toString().toLowerCase();return n.indexOf(r,n.length-r.length)>-1},"*==":function(e,t){return typeof e=="string"&&typeof t=="string"&&e.indexOf(t)>-1},"*=":function(e,t){return e!==null&&t!==null&&e.toString().toLowerCase().indexOf(t.toString().toLowerCase())>-1},"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"%":function(e,t){return e%t}};t._parse=a;var Y=100,Z={},et=[];t.apply=function(e,t,n){return Z[e]||(Z[e]=a(e),et.push(e)>Y&&delete Z[et.shift()]),Z[e](t,t,n||{})}});