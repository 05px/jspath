/**
* JSPath
*
* Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
* With parts by Marat Dulin (mdevils@gmail.com)
* Dual licensed under the MIT and GPL licenses:
* http://www.opensource.org/licenses/mit-license.php
* http://www.gnu.org/licenses/gpl.html
*
* @version 0.1.2
*/(function(e){var t;typeof exports=="object"?e(t,exports):typeof define=="function"?define(e):e(t,JSPath={})})(function(e,t){function s(e){return Function("data,subst",i(r(e)))}var n={PATH:1,SELECTOR:2,OBJECT_PREDICATE:3,ARRAY_PREDICATE:4,LOGICAL_EXPRESSION:5,BINARY_EXPRESSION:6,UNARY_EXPRESSION:7,ARRAY_EXPRESSION:8,LITERAL:9,SUBST:10},r=function(){function u(t){r=t,i=0,s=null,o=r.length;var n=a(),u=A();return u.type!==e.EOP&&F(u),n}function a(){var e=!1;T("^")&&(A(),e=!0),N()||F(A());var t=[],r;while(i<o){r=f();if(!r)break;t.push(r)}return{type:n.PATH,fromRoot:e,parts:t}}function f(){if(N())return l();if(T("["))return h();if(T("{"))return p()}function l(){var t=A().val,r=k(),i;if(T("*")||t===".."||r.type===e.ID||r.type===e.STRING)i=c();return{type:n.SELECTOR,selector:t,prop:i}}function c(){var t=A(),n=t.type;if(n===e.ID||n===e.STRING||n===e.PUNCTUATOR&&t.val==="*")return t.val;F(t)}function h(){C("[");var e=w();return C("]"),{type:n.ARRAY_PREDICATE,arg:e}}function p(){C("{");var e=d();return C("}"),{type:n.OBJECT_PREDICATE,arg:e}}function d(){var e=v(),t;while(T("||"))A(),(t||(t=[e])).push(v());return t?{type:n.LOGICAL_EXPRESSION,op:"||",args:t}:e}function v(){var e=m(),t;while(T("&&"))A(),(t||(t=[e])).push(m());return t?{type:n.LOGICAL_EXPRESSION,op:"&&",args:t}:e}function m(){var e=g();while(T("==")||T("!=")||T("===")||T("!==")||T("^=")||T("^==")||T("$==")||T("$=")||T("*==")||T("*="))e={type:n.BINARY_EXPRESSION,op:A().val,args:[e,m()]};return e}function g(){var e=y();while(T("<")||T(">")||T("<=")||T(">="))e={type:n.BINARY_EXPRESSION,op:A().val,args:[e,g()]};return e}function y(){var e=b();while(T("+")||T("-"))e={type:n.BINARY_EXPRESSION,op:A().val,args:[e,y()]};return e}function b(){var e=E();while(T("*")||T("/")||T("%"))e={type:n.BINARY_EXPRESSION,op:A().val,args:[e,b()]};return e}function w(){if(T(":"))return A(),{type:n.ARRAY_EXPRESSION,toIdx:E()};var e=E();return T(":")?(A(),T("]")?{type:n.ARRAY_EXPRESSION,fromIdx:e}:{type:n.ARRAY_EXPRESSION,fromIdx:e,toIdx:E()}):{type:n.ARRAY_EXPRESSION,idx:e}}function E(){return T("!")||T("-")?{type:n.UNARY_EXPRESSION,op:A().val,arg:E()}:S()}function S(){var t=k(),r=t.type;return r===e.STRING||r===e.NUMERIC||r===e.BOOLEAN?{type:n.LITERAL,val:A().val}:r===e.ID&&t.val[0]==="$"?{type:n.SUBST,name:A().val.substr(1)}:T("^")||N()?a():T("(")?x():F(A())}function x(){C("(");var e=d();return C(")"),e}function T(t){var n=k();return n.type===e.PUNCTUATOR&&n.val===t}function N(){var t=k();if(t.type===e.PUNCTUATOR){var n=t.val;return n==="."||n===".."}return!1}function C(t){var n=A();(n.type!==e.PUNCTUATOR||n.val!==t)&&F(n)}function k(){if(s!==null)return s;var e=i;return s=L(),i=e,s}function L(){while(M(r[i]))++i;if(i>=o)return{type:e.EOP,range:[i,i]};var t=j();if(t||(t=H())||(t=H())||(t=B())||(t=P()))return t;F({val:r[i],range:[i,i]})}function A(){var e;return s?(i=s.range[1],e=s,s=null,e):L()}function O(e){return"0123456789".indexOf(e)>=0}function M(e){return e===" "}function _(e){return e==="$"||e==="_"||e>="a"&&e<="z"||e>="A"&&e<="Z"}function D(e){return _(e)||e>="0"&&e<="9"}function P(){var t=r[i];if(!_(t))return;var n=i,s=t;while(++i<o){t=r[i];if(!D(t))break;s+=t}return s==="true"||s==="false"?{type:e.BOOLEAN,val:s==="true",range:[n,i]}:{type:e.ID,val:s,range:[n,i]}}function H(){if(r[i]!=='"')return;var t=++i,n="",s;while(i<o){s=r[i++];if(s==='"')break;n+=s}return{type:e.STRING,val:n,range:[t,i]}}function B(){var t=i,n=r[i],s=n===".";if(s||O(n)){var u=n;while(++i<o){n=r[i];if(n==="."){if(s)return;s=!0}else if(!O(n))break;u+=n}return{type:e.NUMERIC,val:s?parseFloat(u):parseInt(u,10),range:[t,i]}}}function j(){var t=i,n=r[i],s=r[i+1];if(n==="."){if(O(s))return;return r[++i]==="."?{type:e.PUNCTUATOR,val:"..",range:[t,++i]}:{type:e.PUNCTUATOR,val:".",range:[t,i]}}if(s==="="){var o=r[i+2];if(o==="="){if("=!^$*".indexOf(n)>=0)return{type:e.PUNCTUATOR,val:n+s+o,range:[t,i+=3]}}else if("=!^$*><".indexOf(n)>=0)return{type:e.PUNCTUATOR,val:n+s,range:[t,i+=2]}}if(n===s&&(n==="|"||n==="&"))return{type:e.PUNCTUATOR,val:n+s,range:[t,i+=2]};if(":{}()[]^+-*/%!><".indexOf(n)>=0)return{type:e.PUNCTUATOR,val:n,range:[t,++i]}}function F(n){n.type===e.EOP&&I(n,t.UNEXPECTED_EOP),I(n,t.UNEXPECTED_TOKEN,n.val)}function I(e,t){var n=Array.prototype.slice.call(arguments,2),r=t.replace(/%(\d)/g,function(e,t){return n[t]||""}),i=new Error(r);throw i.column=e.range[0],i}var e={ID:1,NUMERIC:2,STRING:3,BOOLEAN:4,PUNCTUATOR:5,EOP:6},t={UNEXPECTED_TOKEN:'Unexpected token "%0"',UNEXPECTED_EOP:"Unexpected end of path"},r,i,s,o;return u}(),i=function(){function s(){if(i.length)return i.shift();var e="v"+ ++r;return t.push(e),e}function o(){for(var e=0,t=arguments.length;e<t;e++)i.push(arguments[e])}function u(n){return e=[],t=["res"],r=0,i=[],a(n,"res","data",!0),"data = Array.isArray(data)? data : [data];"+(t.length?"var "+t.join(",")+";":"")+e.join("")+"return res;"}function a(t,r,i,u){var a=s(),l=t.parts,h=0,v=l.length;e.push(a,"=",t.fromRoot?"data":i,";");while(h<v){var m=l[h++];switch(m.type){case n.SELECTOR:m.selector==".."?p(m,a,a):c(m,a,a);break;case n.OBJECT_PREDICATE:e.push(d(m,a,a));break;case n.ARRAY_PREDICATE:e.push(f(m,a,a))}u&&e.push("if(!",a,".length) {","return ",a,";","}")}e.push(r,"=",a,";"),o(a)}function f(t,n,r){var i=t.arg,u,a;if(i.idx){var f=s();v(i.idx,f,r),e.push(f,"=",l(f,r),";",n,"=",r,"[",f,"] == null? [] : [",r,"[",f,"]];"),o(f)}else i.fromIdx?i.toIdx?(u=s(),a=s(),v(i.fromIdx,u,r),v(i.toIdx,a,r),e.push(u,"=",l(u,r),";",a,"=",l(a,r),";",n,"=",r,".slice(",u,", ",a,");"),o(u,a)):(u=s(),v(i.fromIdx,u,r),e.push(u,"=",l(u,r),";",n,"=",r,".slice(",u,");"),o(u)):(a=s(),v(i.toIdx,a,r),e.push(a,"=",l(a,r),";",n,"=",r,".slice(0, ",a,");"),o(a))}function l(e,t){return[e,"< 0?",t,".length +",e,":",e].join("")}function c(t,n,r){if(!t.prop)e.push(n,"=",r,";");else{var i=E(t.prop),u=s(),a=s(),f=s(),l=s(),c=s(),h=s();e.push(u,"= [],",a,"= 0,",f,"=",r,".length;","while(",a,"<",f,") {",l,"=",r,"[",a,"++];","if(",l,"!= null) {"),t.prop==="*"?e.push("for(",c," in ",l,") {","if(",l,".hasOwnProperty(",c,")) {",h,"=",l,"[",c,"];",S(u,h),"}","}"):e.push(h,"=",l,"[",i,"];",S(u,h)),e.push("}","}",n,"=",u,";"),o(u,a,f,l,c,h)}}function h(t,n,r,i,s){e.push("if(",r,"!= null) {"),t==="*"?e.push("for(",i," in ",r,") {","if(",r,".hasOwnProperty(",i,")) {",s,"=",r,"[",i,"];",S(n,s),"}","}"):e.push(s,"=",r,'["'+t+'"];',S(n,s)),e.push("}")}function p(t,n,r){var i=s(),u=s(),a=s(),f=s(),l=s(),c=s(),p=s(),d=s(),v=s();e.push(i,"=",r,".slice(),",v,"= [];","while(",i,".length) {","if(typeof (",u,"=",i,'.shift()) === "object" &&',u,") {",a,"= [];","if(Array.isArray(",u,")) {",f,"= 0,",d,"=",u,".length;","while(",f,"<",d,") {",c,"=",u,"[",f,"++];",S(a,c),"}","}","else {",p,"= [];"),h(t.prop,p,u,l,c),e.push(S(v,p),"for(",l," in ",u,") {","if(",u,".hasOwnProperty(",l,")) {",c,"=",u,"[",l,"];",S(a,c),"}","}","}",a,".length &&",i,".unshift.apply(",i,",",a,");","}","}",n,"=",v,";"),o(i,u,a,f,l,c,p,d,v)}function d(t,n,r){var i=s(),u=s(),a=s(),f=s(),l=s();e.push(i,"= [];",u,"= 0;",a,"=",r,".length;","while(",u,"<",a,") {",l,"=",r,"[",u,"];"),v(t.arg,f,l),e.push(x(t.arg,f),"&&",i,".push(",l,");","++",u,";","}",n,"=",i,";"),o(i,u,a,l,f)}function v(t,r,i){switch(t.type){case n.PATH:var u=s();a(t,u,"["+i+"]"),e.push(r,"=",u,";"),o(u);break;case n.BINARY_EXPRESSION:C[t.op]?b(t,r,i):m(t,r,i);break;case n.LOGICAL_EXPRESSION:y(t,r,i);break;case n.UNARY_EXPRESSION:w(t,r,i);break;case n.LITERAL:var f=t.val;switch(typeof f){case"string":e.push(r,"=",E(f),";");break;default:e.push(r,"=",f,";")}break;case n.SUBST:e.push(r,"= subst.",t.name,";")}}function m(t,r,i){var u=s(),a=s(),f=s(),l=s(),c=s(),h=s(),p=s(),d=s(),m=t.args[0],y=t.args[1];e.push(r,"= false;"),v(m,u,i),v(y,a,i);var b=m.type===n.PATH,w=y.type===n.LITERAL;e.push(f,"="),b?e.push("true;"):e.push("Array.isArray(",u,");"),e.push(l,"="),w?e.push("false;"):e.push("Array.isArray(",a,");"),e.push("if(",f,"&&",u,".length === 1) {",u,"=",u,"[0];",f,"= false;","}"),w||e.push("if(",l,"&&",a,".length === 1) {",a,"=",a,"[0];",l,"= false;","}"),e.push(c,"= 0;","if(",f,") {",p,"=",u,".length;"),w||(e.push("if(",l,") {",d,"=",a,".length;","while(",c,"<",p,"&& !",r,") {",h,"= 0;","while(",h,"<",d,") {"),g(t.op,[u,"[",c,"]"].join(""),[a,"[",h,"]"].join("")),e.push(r,"= true;","break;","}","++",h,";","}","++",c,";","}","}","else {")),e.push("while(",c,"<",p,") {"),g(t.op,[u,"[",c,"]"].join(""),a),e.push(r,"= true;","break;","}","++",c,";","}"),w||e.push("}"),e.push("}"),w||(e.push("else if(",l,") {",d,"=",a,".length;","while(",c,"<",d,") {"),g(t.op,u,[a,"[",c,"]"].join("")),e.push(r,"= true;","break;","}","++",c,";","}","}")),e.push("else {",r,"=",N[t.op](u,a),";","}"),o(u,a,f,l,c,h,p,d)}function g(t,n,r){e.push("if(",N[t](n,r),") {")}function y(t,n,r){var i=[],u=t.args,a=u.length,f=0,l;e.push(n,"= false;");switch(t.op){case"&&":while(f<a)i.push(l=s()),v(u[f],l,r),e.push("if(",x(u[f++],l),") {");e.push(n,"= true;");break;case"||":while(f<a)i.push(l=s()),v(u[f],l,r),e.push("if(",x(u[f],l),") {",n,"= true;","}"),f++ +1<a&&e.push("else {");--a}while(a--)e.push("}");o.apply(i)}function b(t,n,r){var i=s(),u=s();v(t.args[0],i,r),v(t.args[1],u,r),e.push(n,"=",N[t.op](T(t.args[0],i),T(t.args[1],u)),";"),o(i,u)}function w(t,n,r){var i=s();v(t.arg,i,r);switch(t.op){case"!":e.push(n,"= !",x(t.arg,i)+";");break;case"-":e.push(n,"= -",T(t.arg,i)+";")}o(i)}function E(e){return"'"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"}function S(e,t){return[t,"!= null &&","(Array.isArray(",t,")? ",e,"=",e,".concat(",t,") :",e,".push(",t,")",");"].join("")}function x(e,t){switch(e.type){case n.LOGICAL_EXPRESSION:return t;case n.LITERAL:return"!!"+t;case n.PATH:return t+".length > 0";default:return["(typeof ",t,'=== "boolean"?',t,":","Array.isArray(",t,")?",t,".length > 0 : !!",t,")"].join("")}}function T(e,t){switch(e.type){case n.LITERAL:return t;case n.PATH:return t+"[0]";default:return["(Array.isArray(",t,")?",t,"[0] : ",t,")"].join("")}}var e,t,r,i,N={"===":function(e,t){return e+"==="+t},"==":function(e,t){return"typeof "+e+'=== "string" && typeof '+t+'=== "string"?'+e+".toLowerCase() ==="+t+".toLowerCase() :"+e+"=="+t},">=":function(e,t){return e+">="+t},">":function(e,t){return e+">"+t},"<=":function(e,t){return e+"<="+t},"<":function(e,t){return e+"<"+t},"!==":function(e,t){return e+"!=="+t},"!=":function(e,t){return e+"!="+t},"^==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t+'=== "string" &&',e,".indexOf(",t,") === 0"].join("")},"^=":function(e,t){return[e,"!= null &&",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) === 0"].join("")},"$==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".lastIndexOf(",t,") ===",e,".length - ",t,".length"].join("")},"$=":function(e,t){return[e,"!= null &&",t,"!= null &&","(",e,"=",e,".toLowerCase().toString()).indexOf(","(",t,"=",t,".toLowerCase().toLowerCase())) ===",e,".length -",t,".length"].join("")},"*==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".indexOf(",t,") > -1"].join("")},"*=":function(e,t){return[e,"!= null && ",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) > -1"].join("")},"+":function(e,t){return e+"+"+t},"-":function(e,t){return e+"-"+t},"*":function(e,t){return e+"*"+t},"/":function(e,t){return e+"/"+t},"%":function(e,t){return e+"%"+t}},C={"+":1,"-":1,"*":1,"/":1,"%":1};return u}(),o={},u=[],a={cacheSize:100},f={cacheSize:function(e,t){if(t<e&&u.length>t){var n=u.splice(0,u.length-t),r=n.length,i=0;while(i<r)delete o[n[i++]]}}};t.params=function(e){if(!arguments.length)return a;for(var t in e)e.hasOwnProperty(t)&&(f[t]&&f[t](a[t],e[t]),a[t]=e[t])},t.compile=s,t.apply=function(e,t,n){return o[e]||(o[e]=s(e),u.push(e)>a.cacheSize&&delete o[u.shift()]),o[e](t,n||{})}});